<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NNWKQ6SSHN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-NNWKQ6SSHN');
    </script>
    <!-- Microsoft Clarity Analytics -->
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "ujzwruoqtu");
    </script>
    <!-- Environment Config (Generated at Build Time) -->
    <!-- Contains SHARED_CHATBOT_KEY for Direct API Calls -->
    <script src="js/env-config.js"></script>
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Font Awesome for Professional Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="js/supabase-config.js"></script>

    <script src="js/auth-manager.js"></script>
    <script src="js/sync-manager.js" defer></script>
    <script src="js/community-manager.js?v=1.3" defer></script>
    <script src="js/social-manager.js?v=1.3" defer></script>
    <!-- Firebase SDK for Cloud Messaging -->
    <script type="module">
        // ==================== FIREBASE CONFIGURATION ====================
        // IMPORTANT: Replace the placeholder values below with your actual
        // Firebase config from: Firebase Console > Project Settings > General > Your apps
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_AbhNHG3WkRjtKfoLkHvrZaWxhJf3Zyk",
            authDomain: "bunk-it-notifications.firebaseapp.com",
            projectId: "bunk-it-notifications",
            storageBucket: "bunk-it-notifications.firebasestorage.app",
            messagingSenderId: "360203480812",
            appId: "1:360203480812:web:9350364110a5db986c7fc9",
            measurementId: "G-DFTJC9Q81Z"
        };

        // VAPID key from Firebase Console > Cloud Messaging > Web Push certificates
        const VAPID_KEY = "BGRvIc4cMEwLInvR809i2aFUUt6OgvgcFhrrqzQhq3VtW1udIBzWX5d_Cg3s_zCGSkBu18s8PaPNkFvJAQr72iE";

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const messaging = getMessaging(firebaseApp);
        const db = getFirestore(firebaseApp);

        // Store globally for use in other scripts
        window.firebaseMessaging = messaging;
        window.VAPID_KEY = VAPID_KEY;
        window.firestoreDb = db;

        // Save token to Firestore
        async function saveTokenToFirestore(token) {
            try {
                const userRef = doc(db, "notification_tokens", token);
                await setDoc(userRef, {
                    token: token,
                    reminderTime: "18:00", // Default time
                    enabled: true,
                    updatedAt: serverTimestamp(),
                    deviceType: /Mobi|Android/i.test(navigator.userAgent) ? 'mobile' : 'desktop'
                }, { merge: true });
                console.log("✅ FCM Token saved to Firestore");
            } catch (e) {
                console.error("❌ Error adding token to Firestore: ", e);
            }
        }

        // Request notification permission and get FCM token
        window.requestNotificationPermission = async function () {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('🔔 Notification permission granted.');
                    const token = await getToken(messaging, { vapidKey: VAPID_KEY });
                    if (token) {
                        console.log('🔑 FCM Token:', token);
                        // Store token locally (for both guest and logged-in users)
                        localStorage.setItem('fcmToken', token);

                        // Save to Firestore for scheduled notifications
                        await saveTokenToFirestore(token);

                        // If user is logged in, sync token to backend (optional)
                        if (typeof window.syncFCMToken === 'function') {
                            window.syncFCMToken(token);
                        }
                        return token;
                    } else {
                        console.log('⚠️ No FCM registration token available.');
                    }
                } else {
                    console.log('❌ Notification permission denied.');
                }
            } catch (err) {
                console.error('FCM Token Error:', err);
            }
            return null;
        };

        // Handle foreground messages
        onMessage(messaging, (payload) => {
            console.log('📩 Foreground message received:', payload);
            // Show in-app notification or toast
            if (typeof showToast === 'function') {
                const title = payload.notification?.title || 'New Notification';
                const body = payload.notification?.body || '';
                showToast(`${title}: ${body}`, 'info');
            }
        });

        console.log('🔥 Firebase Messaging initialized');
    </script>
    <!-- App Recovery: Detect and fix black screen issues -->
    <script>
        (function () {
            'use strict';

            // EMERGENCY: If page stuck, enable this URL param to force clear
            if (location.search.includes('forceclear')) {
                if ('caches' in window) caches.keys().then(n => n.forEach(c => caches.delete(c)));
                if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(r => r.forEach(s => s.unregister()));
                localStorage.clear();
                sessionStorage.clear();
                alert('Cache cleared! Page will reload.');
                location.href = location.origin + location.pathname;
                return;
            }

            // Recovery timeout - if app doesn't load in 5 seconds, try recovery
            const APP_LOAD_TIMEOUT = 5000;
            const RECOVERY_KEY = 'bunkit_last_recovery';
            const RECOVERY_COOLDOWN = 30000; // 30 seconds between recovery attempts

            // Check if we recently attempted recovery (prevent infinite loops)
            const lastRecovery = localStorage.getItem(RECOVERY_KEY);
            const now = Date.now();
            const recentRecovery = lastRecovery && (now - parseInt(lastRecovery)) < RECOVERY_COOLDOWN;

            // Set up recovery timer
            const recoveryTimer = setTimeout(async () => {
                // Check if body has content (app loaded)
                const body = document.body;
                const hasContent = body && body.innerHTML.trim().length > 500;

                if (!hasContent) {
                    console.warn('⚠️ App appears stuck - attempting recovery...');

                    if (!recentRecovery) {
                        // Mark recovery attempt
                        localStorage.setItem(RECOVERY_KEY, now.toString());

                        // Try to clear service worker cache
                        if ('caches' in window) {
                            try {
                                const cacheNames = await caches.keys();
                                await Promise.all(cacheNames.map(name => caches.delete(name)));
                                console.log('✅ Cleared all caches');
                            } catch (e) {
                                console.error('Cache clear failed:', e);
                            }
                        }

                        // Unregister service workers
                        if ('serviceWorker' in navigator) {
                            try {
                                const registrations = await navigator.serviceWorker.getRegistrations();
                                await Promise.all(registrations.map(r => r.unregister()));
                                console.log('✅ Unregistered service workers');
                            } catch (e) {
                                console.error('SW unregister failed:', e);
                            }
                        }

                        // Force hard reload
                        location.reload(true);
                    } else {
                        console.log('⏳ Recovery attempted recently, waiting...');
                    }
                }
            }, APP_LOAD_TIMEOUT);

            // Cancel recovery timer when app loads successfully
            window.addEventListener('load', () => {
                clearTimeout(recoveryTimer);
                localStorage.removeItem(RECOVERY_KEY);
                console.log('✅ App loaded successfully');
            });

            // Also cancel on DOMContentLoaded
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => clearTimeout(recoveryTimer), 3000);
            });
        })();
    </script>
    <!-- Anti-DevTools Protection (deters casual users) -->
    <script>
        (function () {
            'use strict';

            // Disable right-click context menu
            document.addEventListener('contextmenu', function (e) {
                e.preventDefault();
                console.log('🔒 Right-click disabled');
            });

            // Block common DevTools keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                // F12
                if (e.key === 'F12') {
                    e.preventDefault();
                    console.log('🔒 F12 blocked');
                    return false;
                }
                // Ctrl+Shift+I (DevTools)
                if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                    e.preventDefault();
                    console.log('🔒 Ctrl+Shift+I blocked');
                    return false;
                }
                // Ctrl+Shift+J (Console)
                if (e.ctrlKey && e.shiftKey && e.key === 'J') {
                    e.preventDefault();
                    console.log('🔒 Ctrl+Shift+J blocked');
                    return false;
                }
                // Ctrl+Shift+C (Element inspector)
                if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                    e.preventDefault();
                    console.log('🔒 Ctrl+Shift+C blocked');
                    return false;
                }
                // Ctrl+U (View source)
                if (e.ctrlKey && e.key === 'u') {
                    e.preventDefault();
                    console.log('🔒 Ctrl+U blocked');
                    return false;
                }
                // Ctrl+S (Save page)
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    console.log('🔒 Ctrl+S blocked');
                    return false;
                }
            });

            // DevTools detection (warns in console)
            let devToolsOpen = false;
            const threshold = 160;

            setInterval(function () {
                const widthThreshold = window.outerWidth - window.innerWidth > threshold;
                const heightThreshold = window.outerHeight - window.innerHeight > threshold;

                if (widthThreshold || heightThreshold) {
                    if (!devToolsOpen) {
                        devToolsOpen = true;
                        console.log('%c⚠️ DevTools detected - Welcome developer! 👋', 'font-size: 20px; color: #ff6b6b;');
                    }
                } else {
                    devToolsOpen = false;
                }
            }, 1000);

            // Disable text selection on double-click for UI elements
            document.addEventListener('selectstart', function (e) {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    // Allow selection in form elements
                    if (!e.target.isContentEditable) {
                        // Keep enabled for now - only block if needed
                    }
                }
            });

            console.log('%c🔒 Security measures active', 'color: #28a745; font-weight: bold;');
        })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Bunk it - Free Attendance Tracker App for College Students | 75% Calculator</title>

    <!-- Primary SEO Meta Tags -->
    <meta name="description"
        content="Bunk it is India's #1 free attendance tracker app for college & university students. Calculate how many classes you can skip, maintain 75% attendance, track subjects, and never get detained. Works offline! Used by 50,000+ students across IITs, NITs, and colleges.">
    <meta name="keywords"
        content="attendance tracker app, bunk calculator, college attendance app, 75 percent attendance calculator, how many classes can I skip, attendance manager app, student attendance tracker, proxy attendance, class attendance calculator, bunking classes calculator, college bunk app, attendance shortage calculator, minimum attendance calculator, engineering attendance, medical college attendance, university attendance tracker, class skip calculator, attendance percentage calculator, free attendance app, offline attendance app, best attendance app for students, attendance app India, IIT attendance, NIT attendance, VIT attendance, SRM attendance, college ka attendance, bunk kaise kare, kitni class bunk kar sakte hain, attendance kaise calculate kare">
    <meta name="author" content="Bunk it - Made for Indian Students">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="bingbot" content="index, follow">
    <link rel="canonical" href="https://bunkitapp.in/">

    <!-- Geographic & Language Targeting for India -->
    <meta name="geo.region" content="IN">
    <meta name="geo.country" content="India">
    <meta name="geo.placename" content="India">
    <meta name="language" content="English, Hindi">
    <meta http-equiv="content-language" content="en-IN">
    <link rel="alternate" hreflang="en-IN" href="https://bunkitapp.in/">
    <link rel="alternate" hreflang="hi" href="https://bunkitapp.in/">
    <link rel="alternate" hreflang="x-default" href="https://bunkitapp.in/">

    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" href="ios-splash.png"
        media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="ios-splash.png"
        media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="ios-splash.png"
        media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="ios-splash.png"
        media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="ios-splash.png"
        media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="ios-splash.png"
        media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="ios-splash.png"
        media="(device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2)">
    <!-- iPad Air 4 -->
    <link rel="apple-touch-startup-image" href="ios-splash.png"
        media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)">
    <!-- iPad 10.5 -->
    <link rel="apple-touch-startup-image" href="ios-splash.png"
        media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">
    <!-- iPad Pro 11 -->
    <link rel="apple-touch-startup-image" href="ios-splash.png"
        media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)">
    <!-- iPad Mini, Air -->


    <!-- Additional SEO Signals -->
    <meta name="rating" content="General">
    <meta name="distribution" content="Global">
    <meta name="revisit-after" content="3 days">
    <meta name="coverage" content="Worldwide">
    <meta name="target" content="all">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <!-- Open Graph / Facebook / LinkedIn / WhatsApp -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bunkitapp.in/">
    <meta property="og:title" content="Bunk it - Free Attendance Tracker for College Students">
    <meta property="og:description"
        content="India's smartest attendance app! Calculate bunks, track 75% attendance, manage subjects. Used by 50,000+ students. Free & works offline!">
    <meta property="og:image" content="https://bunkitapp.in/icon-512x512.png">
    <meta property="og:image:secure_url" content="https://bunkitapp.in/icon-512x512.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    <meta property="og:image:alt" content="Bunk it - Attendance Tracker App Logo">
    <meta property="og:site_name" content="Bunk it">
    <meta property="og:locale" content="en_IN">
    <meta property="og:locale:alternate" content="hi_IN">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@bunkitapp">
    <meta name="twitter:creator" content="@bunkitapp">
    <meta name="twitter:url" content="https://bunkitapp.in/">
    <meta name="twitter:title" content="Bunk it - Free Attendance Tracker for College Students">
    <meta name="twitter:description"
        content="Calculate how many classes you can bunk! Track 75% attendance. Used by 50,000+ Indian students. Free & offline!">
    <meta name="twitter:image" content="https://bunkitapp.in/icon-512x512.png">
    <meta name="twitter:image:alt" content="Bunk it App - Smart Attendance Manager">

    <!-- Additional SEO -->
    <meta name="application-name" content="Bunk it">
    <meta name="apple-mobile-web-app-title" content="Bunk it">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-TileImage" content="/icon-144x144.png">
    <meta name="msapplication-config" content="none">

    <!-- Structured Data: WebApplication Schema -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "@id": "https://bunkitapp.in/#webapp",
        "name": "Bunk it - Smart Attendance Manager",
        "alternateName": ["Bunk it", "Bunkit", "Bunk Calculator", "Attendance Tracker", "College Attendance App"],
        "description": "India's #1 free attendance tracker app for college students. Calculate how many classes you can skip, maintain 75% attendance, and never get detained.",
        "url": "https://bunkitapp.in/",
        "applicationCategory": "EducationalApplication",
        "applicationSubCategory": "Student Tools",
        "operatingSystem": "Any (Web, Android, iOS)",
        "browserRequirements": "Requires JavaScript. Works on Chrome, Firefox, Safari, Edge",
        "softwareVersion": "2.0",
        "datePublished": "2024-01-01",
        "dateModified": "2024-12-11",
        "inLanguage": ["en-IN", "hi-IN", "en"],
        "isAccessibleForFree": true,
        "isFamilyFriendly": true,
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "INR",
            "availability": "https://schema.org/InStock"
        },
        "author": {
            "@type": "Organization",
            "name": "Bunk it Team",
            "url": "https://bunkitapp.in/"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Bunk it",
            "logo": {
                "@type": "ImageObject",
                "url": "https://bunkitapp.in/icon-512x512.png"
            }
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "bestRating": "5",
            "worstRating": "1",
            "ratingCount": "12500",
            "reviewCount": "3200"
        },
        "featureList": [
            "Attendance Percentage Calculator",
            "Bunk/Skip Class Calculator", 
            "75% Attendance Requirement Tracker",
            "Subject-wise Attendance Management",
            "Timetable Integration",
            "Offline Mode Support",
            "Smart Notifications",
            "Data Export/Import",
            "Multi-class Support",
            "Holiday Management",
            "OCR Screenshot Import",
            "AI-Powered Assistance"
        ],
        "keywords": "attendance tracker, bunk calculator, college attendance, 75% attendance, skip class calculator"
    }
    </script>

    <!-- Structured Data: FAQPage Schema (Major SEO Boost) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
                "@type": "Question",
                "name": "How many classes can I bunk to maintain 75% attendance?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Use Bunk it's bunk calculator to find out exactly how many classes you can skip while maintaining 75% attendance. Enter your current attendance and total classes, and the app will calculate your safe bunk limit instantly."
                }
            },
            {
                "@type": "Question",
                "name": "Is Bunk it free to use?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes, Bunk it is completely free! No ads, no subscriptions, no hidden charges. It's made by students for students."
                }
            },
            {
                "@type": "Question",
                "name": "Does Bunk it work offline?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes! Bunk it is a PWA (Progressive Web App) that works fully offline. Your attendance data is stored locally and you can track everything without internet."
                }
            },
            {
                "@type": "Question",
                "name": "How do I calculate my attendance percentage?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Bunk it automatically calculates your attendance percentage. Just log your daily attendance (present/absent), and it shows your percentage for each subject and overall attendance."
                }
            },
            {
                "@type": "Question",
                "name": "Which colleges is Bunk it designed for?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Bunk it works for all colleges and universities - IITs, NITs, VIT, SRM, engineering colleges, medical colleges, and any institution with attendance requirements."
                }
            }
        ]
    }
    </script>

    <!-- Structured Data: Organization -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Bunk it",
        "url": "https://bunkitapp.in/",
        "logo": "https://bunkitapp.in/icon-512x512.png",
        "description": "Makers of India's #1 attendance tracking app for college students",
        "foundingDate": "2024",
        "areaServed": "Worldwide",
        "audience": {
            "@type": "EducationalAudience",
            "educationalRole": "student"
        }
    }
    </script>
    <!-- Microsoft Clarity Analytics -->
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "YOUR_CLARITY_ID");
    </script>
    <!-- Confetti Animation Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js" defer></script>
    <!-- CDN Libraries: Loaded on-demand by js/app.js when feature is used -->
    <!-- LZ-String for URL Compression (needed immediately for class import links) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <!-- Google Identity Services for OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Google API for Drive -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea" />
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="icon" type="image/png" href="icon-192x192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="js/pull-to-refresh.js"></script>
    <script src="js/pwa-compat.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('ServiceWorker registration successful');

                    // === AUTO-REFRESH: Check for updates on every page load ===
                    registration.update(); // Force check for new SW version

                    // Listen for new service worker installing
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('New service worker found, installing...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New content is available, refresh the page
                                console.log('New content available! Refreshing...');
                                showToast('🔄 Update available! reloading...', 'info');
                                // Skip waiting and activate immediately
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                            }
                        });
                    });

                    // Refresh page when new service worker takes control
                    let refreshing = false;
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (!refreshing) {
                            refreshing = true;
                            console.log('New service worker activated, reloading page...');
                            window.location.reload();
                        }
                    });

                    // Register for background sync if supported
                    if ('sync' in registration) {
                        // Register sync when going offline
                        window.addEventListener('offline', async () => {
                            console.log('App went offline, registering sync...');
                        });

                        // Trigger sync when coming back online
                        window.addEventListener('online', async () => {
                            console.log('App back online, triggering sync...');
                            try {
                                await registration.sync.register('sync-attendance');
                                await registration.sync.register('sync-settings');
                                console.log('Background sync registered');
                            } catch (e) {
                                console.log('Background sync registration failed:', e);
                            }
                        });
                    }

                    // === OPTIMIZATION: Request Periodic Background Sync (Chrome/Android) ===
                    if ('periodicSync' in registration) {
                        try {
                            const status = await navigator.permissions.query({
                                name: 'periodic-background-sync',
                            });

                            if (status.state === 'granted') {
                                await registration.periodicSync.register('check-notification', {
                                    minInterval: 12 * 60 * 60 * 1000 // 12 hours (browser minimum)
                                });
                                console.log('Periodic background sync registered');
                            }
                        } catch (e) {
                            console.log('Periodic sync registration failed:', e);
                        }
                    }

                    // === OPTIMIZATION: Keep-Alive Heartbeat ===
                    // Pings the SW every 25s to keep it from going idle while app is in background (but not closed)
                    setInterval(() => {
                        if (navigator.serviceWorker.controller) {
                            navigator.serviceWorker.controller.postMessage({ type: 'KEEP_ALIVE' });
                        }
                    }, 25000);
                } catch (err) {
                    console.log('ServiceWorker registration failed: ', err);
                }
            });
        }
    </script>
    <link rel="preload" href="css/styles.css" as="style">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Universal Backdrop Overlay - Blocks all interactions when panels are open -->
    <div id="appBackdrop" class="app-backdrop" onclick="closeAllPanels()"></div>

    <!-- Login Screen -->
    <!-- RESET PASSWORD MODAL (Relocated to Root for Z-Index) -->
    <div class="rp-modal-overlay" id="resetPasswordModal" style="display: none; z-index: 99999999;">
        <div class="rp-modal">
            <div class="rp-modal-header">
                <i class="fa-solid fa-lock-open"></i>
                <h3>Set New Password</h3>
                <p>Enter your new password below</p>
            </div>
            <div class="rp-modal-body">
                <div class="rp-password-wrapper">
                    <input type="password" id="rpNewPassword" placeholder="New Password">
                    <span class="rp-password-toggle" onclick="toggleRpPassword('rpNewPassword', this)">
                        <i class="fa-regular fa-eye"></i>
                    </span>
                </div>
                <div class="rp-password-wrapper">
                    <input type="password" id="rpConfirmPassword" placeholder="Confirm New Password">
                    <span class="rp-password-toggle" onclick="toggleRpPassword('rpConfirmPassword', this)">
                        <i class="fa-regular fa-eye"></i>
                    </span>
                </div>
                <div class="rp-requirements">
                    ℹ️ Password must be at least 6 characters long
                </div>
                <div class="rp-status" id="rpStatus"></div>
            </div>
            <div class="rp-modal-buttons">
                <!-- Cancel button hidden by JS enforcer but kept for structure -->
                <button class="rp-btn rp-btn-cancel" onclick="closeResetPasswordModal()">Cancel</button>
                <button class="rp-btn rp-btn-primary" id="rpSubmitBtn" onclick="submitNewPassword()">
                    <i class="fa-solid fa-check"></i> Update Password
                </button>
            </div>
        </div>
    </div>

    <div id="loginScreen" class="login-screen" style="display: none;">
        <div class="login-container">
            <div class="login-logo">📚</div>
            <h1 class="login-title">Welcome to Bunkit</h1>
            <p class="login-subtitle">Smart Attendance Manager</p>

            <button class="login-btn login-btn-google" onclick="signInWithGoogle()" style="display: none !important;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Google
            </button>
            <p class="login-feature">☁️ Sync across all devices</p>

            <div class="login-divider"><span>or</span></div>

            <!-- Email Auth Section -->
            <div id="emailAuthSection" style="width: 100%; margin-bottom: 20px;">
                <input type="text" id="signupName" class="auth-input" placeholder="Full Name" style="display: none;">
                <input type="email" id="loginEmail" class="auth-input" placeholder="Email Address">

                <!-- Password with Eye Icon -->
                <div class="password-input-wrapper">
                    <input type="password" id="loginPassword" class="auth-input" placeholder="Password">
                    <span class="password-toggle-icon" onclick="togglePasswordVisibility('loginPassword', this)">
                        <i class="fa-regular fa-eye"></i>
                    </span>
                </div>

                <!-- Confirm Password (Signup Only) with Eye Icon -->
                <div class="password-input-wrapper" id="confirmPasswordWrapper" style="display: none;">
                    <input type="password" id="signupConfirmPassword" class="auth-input" placeholder="Confirm Password">
                    <span class="password-toggle-icon"
                        onclick="togglePasswordVisibility('signupConfirmPassword', this)">
                        <i class="fa-regular fa-eye"></i>
                    </span>
                </div>

                <!-- Checkbox to Import Local Data (Only for Signup) -->
                <div id="signupDataOption"
                    style="display: none; margin-bottom: 15px; text-align: left; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                    <label
                        style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #cbd5e1; font-size: 0.9rem;">
                        <input type="checkbox" id="importLocalData" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>Keep existing data from this device?</span>
                    </label>
                    <p style="font-size: 0.75rem; color: #94a3b8; margin-top: 5px; margin-left: 28px;">
                        Check this if you want to move your Guest data to this new account.
                    </p>
                </div>

                <button class="primary-auth-btn" id="emailAuthBtn" onclick="handleEmailSubmit()">Sign In</button>

                <div class="toggle-auth-mode" onclick="toggleAuthMode()" id="authModeToggle">
                    New here? Create an account
                </div>
                <div style="text-align: center; margin-top: 12px;">
                    <span class="forgot-password-link" onclick="window.promptPasswordReset(event)">
                        <i class="fa-solid fa-key"></i> Forgot Password?
                    </span>
                </div>
            </div>

            <div class="login-divider"><span>or continue as guest</span></div>

            <button class="login-btn login-btn-guest" onclick="AuthManager.continueAsGuest()">
                👤 Continue as Guest
            </button>
            <p class="login-feature">📱 Data stays on this device</p>
        </div>
    </div>

    <!-- Forgot Password Modal Functions - Defined Early for Immediate Availability -->
    <script>
        // These functions must be available as soon as the login screen renders
        window.promptPasswordReset = function (e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            console.log("🔑 Forgot Password Clicked");

            const modal = document.getElementById('forgotPasswordModal');
            if (!modal) {
                // Modal might not be loaded yet, retry after a short delay
                console.warn("Modal not found, retrying...");
                setTimeout(() => window.promptPasswordReset(), 500);
                return;
            }

            const emailInput = document.getElementById('fpEmailInput');
            const loginEmail = document.getElementById('loginEmail');
            const status = document.getElementById('fpStatus');

            // Pre-fill email if available
            if (emailInput && loginEmail && loginEmail.value) {
                emailInput.value = loginEmail.value;
            }

            // Reset status
            if (status) {
                status.className = 'fp-status';
                status.textContent = '';
            }

            // Show modal with forced styles
            modal.classList.add('fp-visible');
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
            modal.style.display = 'flex';
            modal.style.zIndex = '99999999';

            // Focus email input
            if (emailInput) {
                setTimeout(() => emailInput.focus(), 100);
            }

            console.log("✅ Forgot Password Modal Opened");
        };

        window.closeForgotPasswordModal = function () {
            const modal = document.getElementById('forgotPasswordModal');
            if (modal) {
                modal.classList.remove('fp-visible');
                modal.style.opacity = '';
                modal.style.visibility = '';
                modal.style.display = '';
                modal.style.zIndex = '';

                // Reset UI to Email Step after animation
                setTimeout(() => {
                    const sets = [
                        ['fpEmailStep', 'block'], ['fpOtpStep', 'none'],
                        ['fpSubmitBtn', 'inline-block'], ['fpVerifyBtn', 'none']
                    ];
                    sets.forEach(([id, val]) => {
                        const el = document.getElementById(id);
                        if (el) el.style.display = val;
                    });

                    const submitBtn = document.getElementById('fpSubmitBtn');
                    if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Code'; }

                    const verifyBtn = document.getElementById('fpVerifyBtn');
                    if (verifyBtn) { verifyBtn.disabled = false; verifyBtn.innerHTML = '<i class="fa-solid fa-check"></i> Verify & Login'; }

                    const inst = document.getElementById('fpInstruction');
                    if (inst) inst.textContent = "Enter your email address to get a 6-digit code.";

                    const status = document.getElementById('fpStatus');
                    if (status) { status.textContent = ''; status.className = 'fp-status'; }

                    const otpIn = document.getElementById('fpOtpInput');
                    if (otpIn) otpIn.value = '';
                }, 300);
            }
        };

        window.submitPasswordReset = async function () {
            const emailInput = document.getElementById('fpEmailInput');
            const submitBtn = document.getElementById('fpSubmitBtn');
            const status = document.getElementById('fpStatus');
            const email = emailInput ? emailInput.value.trim() : '';

            if (!email) {
                if (status) { status.className = 'fp-status error'; status.textContent = 'Please enter your email address.'; }
                if (emailInput) emailInput.focus();
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                if (status) { status.className = 'fp-status error'; status.textContent = 'Please enter a valid email address.'; }
                if (emailInput) emailInput.focus();
                return;
            }

            if (submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...'; }
            if (status) { status.textContent = ''; status.className = 'fp-status'; }

            try {
                if (!window.AuthManager) throw new Error("AuthManager not loaded.");

                const { error } = await AuthManager.sendPasswordReset(email);

                if (error) throw error;

                // Success: Switch to OTP View
                document.getElementById('fpEmailStep').style.display = 'none';
                document.getElementById('fpOtpStep').style.display = 'block';
                document.getElementById('fpInstruction').textContent = `Code sent to ${email}`;

                submitBtn.style.display = 'none';
                const verifyBtn = document.getElementById('fpVerifyBtn');
                if (verifyBtn) {
                    verifyBtn.style.display = 'inline-block';
                    verifyBtn.disabled = false;
                }

                if (status) { status.className = 'fp-status success'; status.textContent = 'Code sent! Check your inbox.'; }

                setTimeout(() => {
                    const otpIn = document.getElementById('fpOtpInput');
                    if (otpIn) otpIn.focus();
                }, 100);

            } catch (e) {
                if (status) { status.className = 'fp-status error'; status.textContent = e.message || 'Failed to send code.'; }
                if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Code'; }
            }
        };

        window.verifyOtpAndReset = async function () {
            const email = document.getElementById('fpEmailInput').value.trim();
            const otpInput = document.getElementById('fpOtpInput');
            const otp = otpInput ? otpInput.value.trim() : '';
            const verifyBtn = document.getElementById('fpVerifyBtn');
            const status = document.getElementById('fpStatus');

            if (otp.length < 6) {
                if (status) { status.className = 'fp-status error'; status.textContent = 'Please enter the code.'; }
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying...';

            try {
                window.isVerifyingOtp = true; // SEMAPHORE: Block AuthManager locally
                localStorage.setItem('pending_password_reset', 'true'); // PERSISTENCE: Survive potential reload

                const { data, error } = await AuthManager.verifyOtp(email, otp, 'recovery');
                if (error) throw error;

                // Success
                window.isVerifyingOtp = false; // Release semaphore
                if (status) { status.className = 'fp-status success'; status.textContent = 'Verified! Logging you in...'; }

                // Set flag for password reset
                localStorage.setItem('pending_password_reset', 'true');

                setTimeout(() => {
                    window.closeForgotPasswordModal();
                    // Open Update Password Modal and ENFORCE it
                    if (window.enforceResetPasswordModal) {
                        window.enforceResetPasswordModal();
                    } else if (window.showResetPasswordModal) {
                        window.showResetPasswordModal();
                    }
                    if (window.showToast) window.showToast('Verified! Please set a new password.', 'success');
                }, 500);

            } catch (e) {
                window.isVerifyingOtp = false; // Release semaphore
                localStorage.removeItem('pending_password_reset'); // Revert persistence on error
                if (status) { status.className = 'fp-status error'; status.textContent = e.message || 'Invalid code.'; }
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fa-solid fa-check"></i> Verify & Login';
            }
        };

        window.openVerifyEmailModal = function (email) {
            const modal = document.getElementById('verifyEmailModal');
            if (modal) {
                modal.classList.add('fp-visible');
                modal.style.display = 'flex';
                modal.style.zIndex = '99999999';
                const disp = document.getElementById('veEmailDisplay');
                if (disp) disp.textContent = email;
                const inp = document.getElementById('veOtpInput');
                if (inp) { inp.value = ''; setTimeout(() => inp.focus(), 100); }
                const st = document.getElementById('veStatus');
                if (st) { st.textContent = ''; st.className = 'fp-status'; }

                window._pendingVerifyEmail = email;
            }
        };

        window.closeVerifyEmailModal = function () {
            const modal = document.getElementById('verifyEmailModal');
            if (modal) {
                modal.classList.remove('fp-visible');
                modal.style.display = '';
            }
        };

        window.submitEmailVerification = async function () {
            const email = window._pendingVerifyEmail;
            const otpInput = document.getElementById('veOtpInput');
            const otp = otpInput ? otpInput.value.trim() : '';
            const status = document.getElementById('veStatus');
            const btn = document.getElementById('veVerifyBtn');

            if (otp.length < 6) {
                if (status) { status.textContent = "Please enter the code."; status.className = "fp-status error"; }
                return;
            }

            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying...'; }

            try {
                if (!window.AuthManager) throw new Error("AuthManager missing");

                const { data, error } = await AuthManager.verifyOtp(email, otp, 'signup');
                if (error) throw error;

                if (status) { status.textContent = "Verified! Welcome."; status.className = "fp-status success"; }

                // FLAG FOR ONBOARDING: Validated Signup -> Force Onboarding
                localStorage.setItem('forceOnboarding', 'true');

                setTimeout(() => {
                    window.closeVerifyEmailModal();
                    location.reload();
                }, 1000);

            } catch (e) {
                if (status) { status.textContent = e.message || "Invalid code"; status.className = "fp-status error"; }
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-check"></i> Verify'; }
            }
        };

        // Close on Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                window.closeForgotPasswordModal();
            }
        });
    </script>

    <!-- Forgot Password Modal (Moved Here for Early Availability) -->
    <div class="fp-modal-overlay" id="forgotPasswordModal">
        <div class="fp-modal">
            <div class="fp-modal-header">
                <i class="fa-solid fa-key"></i>
                <h3>Reset Password</h3>
            </div>
            <div class="fp-modal-body">
                <p id="fpInstruction">Enter your email address to get a 6-digit code.</p>

                <div id="fpEmailStep">
                    <input type="email" class="fp-modal-input" id="fpEmailInput" placeholder="Enter your email address">
                </div>

                <div id="fpOtpStep" style="display: none;">
                    <input type="text" class="fp-modal-input" id="fpOtpInput" placeholder="Enter 6-digit Code"
                        maxlength="6"
                        style="text-align: center; letter-spacing: 5px; font-size: 1.2rem; margin-top: 10px;">
                    <p style="font-size: 0.85rem; color: #aaa; margin-top: 5px; text-align: center;">Check your email
                        (and spam layout) for the code.</p>
                </div>

                <div class="fp-status" id="fpStatus"></div>
            </div>
            <div class="fp-modal-buttons">
                <button class="fp-btn fp-btn-cancel" onclick="closeForgotPasswordModal()">Cancel</button>

                <button class="fp-btn fp-btn-primary" id="fpSubmitBtn" onclick="submitPasswordReset()">
                    <i class="fa-solid fa-paper-plane"></i> Send Code
                </button>

                <button class="fp-btn fp-btn-primary" id="fpVerifyBtn" onclick="verifyOtpAndReset()"
                    style="display: none;">
                    <i class="fa-solid fa-check"></i> Verify & Login
                </button>
            </div>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div class="fp-modal-overlay" id="verifyEmailModal">
        <div class="fp-modal">
            <div class="fp-modal-header">
                <i class="fa-solid fa-envelope-circle-check"></i>
                <h3>Verify Email</h3>
            </div>
            <div class="fp-modal-body">
                <p>We've sent a 6-digit code to <b id="veEmailDisplay"></b>.</p>

                <input type="text" class="fp-modal-input" id="veOtpInput" placeholder="Enter 6-digit Code" maxlength="6"
                    style="text-align: center; letter-spacing: 5px; font-size: 1.2rem; margin-top: 10px;">
                <p style="font-size: 0.85rem; color: #aaa; margin-top: 5px; text-align: center;">Check your inbox and
                    spam folder.</p>

                <div class="fp-status" id="veStatus"></div>
            </div>
            <div class="fp-modal-buttons">
                <button class="fp-btn fp-btn-cancel" onclick="closeVerifyEmailModal()">Cancel</button>
                <button class="fp-btn fp-btn-primary" id="veVerifyBtn" onclick="submitEmailVerification()">
                    <i class="fa-solid fa-check"></i> Verify
                </button>
            </div>
        </div>
    </div>

    <button class="hamburger-btn-fixed fixed-ui-button" onclick="openNav()">&#9776;</button>
    <div class="theme-switch-wrapper fixed-ui-button">
        <label class="theme-switch" for="theme-checkbox" title="Toggle Dark/Light Mode">
            <input type="checkbox" id="theme-checkbox" aria-label="Toggle Dark Mode" />
            <div class="slider"></div>
        </label>
    </div>

    <!-- WhatsApp Floating Button -->
    <a href="https://wa.me/916386854875?text=Hi!%20I%20need%20help%20with%20Bunk%20it%20app" class="whatsapp-float"
        target="_blank" rel="noopener noreferrer" title="Contact Developer on WhatsApp">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
            <path
                d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z" />
        </svg>
    </a>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="close-btn" onclick="closeNav()">&times;</a>

        <!-- Account Section at Top -->
        <div id="sidebarAccountHeader"
            style="padding: 15px; background: var(--light-bg); border-bottom: 1px solid var(--border-color); margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div id="sidebarUserAvatar"
                    style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-grad-start), var(--primary-grad-end)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; font-weight: 600;">
                    👤</div>
                <div style="flex: 1;">
                    <div id="sidebarUserName" style="font-weight: 600; color: var(--main-text); font-size: 1rem;">Guest
                        User</div>
                    <div id="sidebarUserEmail" style="font-size: 0.75rem; color: var(--medium-text);">Not signed in
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Options -->
        <a href="#" onclick="openProfileNameModal(); closeNav();">✏️ Edit Profile Name</a>

        <!-- Auth Buttons -->
        <a href="#" id="sidebarSignInBtn" onclick="AuthManager.toggleLoginScreen(true); closeNav();">🔐 Sign In / Sign
            Up</a>

        <div id="sidebarSyncStatus"
            style="display:none; padding: 5px 22px; font-size: 0.75rem; color: var(--medium-text);">
            ☁️ Offline
        </div>

        <a href="#" id="sidebarSyncBtn" onclick="if(window.SyncManager) SyncManager.syncOnLogin(); closeNav();"
            style="display: none;">🔄 Sync Now</a>

        <a href="#" id="sidebarSignOutBtn" onclick="AuthManager.signOut(); closeNav();"
            style="display: none; color: #dc3545;">🚪 Sign Out</a>

        <a href="#" id="sidebarDeleteBtn" onclick="AuthManager.deleteAccount(); closeNav();"
            style="display: none; color: #c0392b; font-size: 0.9rem; margin-top: 5px;">🗑️ Delete
            Account</a>

        <!-- Community Option -->
        <a href="#"
            onclick="closeNav(); setTimeout(function(){ var m = document.getElementById('communityModal'); if(m) document.body.appendChild(m); openModal('communityModal'); if(typeof CommunityManager !== 'undefined') CommunityManager.openCommunityModal(); }, 350);">🗳️
            Community</a>

        <!-- File Options -->
        <a href="#" class="sidenav-dropdown-toggle" onclick="toggleDropdown(this)">📁 File <span>▾</span></a>
        <div class="sidenav-dropdown-content">
            <a href="#" onclick="openImportModal(); closeNav();">Import Class (JSON)</a>
            <a href="#" onclick="openExportModal(); closeNav();">Export Class (JSON)</a>
            <a href="#" onclick="openBackupModal(); closeNav();">Backup All Data</a>
            <a href="#" onclick="openRestoreModal(); closeNav();">Restore from Backup</a>
            <a href="#" onclick="restoreDefaultClass(); closeNav();">Restore Default Class</a>
        </div>

        <a href="#" onclick="openNotificationSettings(); closeNav();">🔔 Notification Settings</a>
        <a href="#" onclick="openAPISettings(); closeNav();">🔑 API Settings</a>
        <a href="#" class="sidenav-dropdown-toggle" onclick="toggleDropdown(this)">👁️ View Options <span>▾</span></a>
        <div class="sidenav-dropdown-content">
            <a href="#" onclick="switchView('cards')">🗂️ Card View</a>
            <a href="#" onclick="switchView('table')">📊 Table View</a>
            <a href="#" onclick="switchView('graph')">📈 Analytics Graph</a>
        </div>

        <a href="#" id="periodViewMenuItem" onclick="openPeriodAttendanceModal(); closeNav();" style="display: none;">📊
            Period-wise Attendance</a>

        <a href="#" onclick="openHelpModal(); closeNav();">💡 How to Use</a>

        <!-- Legal & Info Dropdown -->
        <a href="#" class="sidenav-dropdown-toggle" onclick="toggleDropdown(this)">📋 Legal & Info <span>▾</span></a>
        <div class="sidenav-dropdown-content">
            <a href="/about.html" onclick="closeNav();">ℹ️ About Us</a>
            <a href="/faq.html" onclick="closeNav();">❓ FAQ</a>
            <a href="/support.html" onclick="closeNav();">🆘 Support</a>
            <a href="/contact.html" onclick="closeNav();">📞 Contact Us</a>
            <a href="/privacy.html" onclick="closeNav();">🔒 Privacy Policy</a>
            <a href="/terms.html" onclick="closeNav();">📜 Terms of Service</a>
        </div>

        <a href="#" onclick="openDonateModal(); closeNav();" style="color: #ff6b6b; font-weight: 600;">☕ Buy Me a
            Coffee</a>

        <!-- Instagram Follow Button (Small) -->
        <a href="https://www.instagram.com/_faisal.in?igsh=MTd1dzFrMHNzY3JjNA==" target="_blank"
            rel="noopener noreferrer"
            style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 14px; margin: 8px 15px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: white; font-weight: 500; font-size: 0.85rem; border-radius: 8px; text-decoration: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
            </svg>
            Follow on Instagram
        </a>
        <div style="padding: 8px 15px; font-size: 0.75rem; color: var(--medium-text); text-align: center;">
            Made by <strong>Faisal Khan</strong>
        </div>
    </div>
    <div id="menuOverlay" class="menu-overlay" onclick="closeNav()"></div>



    <div class="container">
        <header class="header">
            <h1>Bunk it</h1>
            <p class="header-subtitle" style="font-size: 1.1rem; opacity: 0.9; margin-top: 5px;">Manage your attendance
                like a pro</p>

            <!-- Info Slider -->
            <div class="info-slider"
                style="display: block; width: 100%; overflow: hidden; background: rgba(255,255,255,0.15); border-radius: 8px; margin-top: 15px; padding: 10px 0; min-height: 40px;">
                <div class="slider-track" id="sliderTrack"
                    style="display: flex; width: max-content; animation: marqueeEffect 120s linear infinite;">
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        💡 Portal Mode: Track daily attendance with automatic calculations</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        ⚠️ OCR is 95% accurate - always verify extracted numbers with your screenshot</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        🚀 Fast Setup: Use AI to generate JSON from your timetable screenshot</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        📊 3 View Options: Card View (detailed), Table View (compact), Graph View (visual)</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        ⚡ Edit Anytime: Click attended/total numbers to update in any view</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        🎯 Settings: Toggle between Per-Subject or Overall attendance mode</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        📱 100% Offline: All data saved locally - works without internet</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        🔔 Notifications: Set daily reminders to mark your attendance</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        📅 History Editor: View and edit past logs using the calendar</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        ✨ Safe Skip %: Shows your % after skipping maximum allowed classes</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        🔄 Backup/Restore: Save all classes to file and restore on any device</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        📤 Export/Import: Share class setup with friends via JSON</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        🗓️ Daily Dashboard: Color-coded status (🔴Critical 🟡Low 🟢Safe) for today's classes</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        📝 Daily Logs: Track attended/skipped/cancelled classes for accuracy</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        🏖️ Leave Planner: Enter planned leaves to see impact on attendance</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        🎪 Max Safe Leave: Find exact dates you can skip without issues</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        🌴 Long Weekend Finder: Discover best leave days for extended breaks</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        📊 Can I Skip Today?: Quick check for today's class impact</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        🤖 Smart Baseline: Portal logs before baseline intelligently merged</div>
                    <div class="slide"
                        style="flex-shrink: 0; padding: 0 40px; font-size: 0.95rem; color: #ffffff; white-space: nowrap; font-weight: 500;">
                        📜 Auto History: Last 10 calculations saved - restore anytime</div>
                </div>
            </div>
            <!-- Auth Modal -->
            <div id="authModal" class="modal">
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3 id="authModalTitle">Sign In</h3> <!-- Dynamic Title -->
                        <span class="close-btn" onclick="closeAuthModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div id="authError"
                            style="display:none; color: #dc3545; background: #ffe6e6; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem;">
                        </div>

                        <form id="authForm" onsubmit="handleAuthSubmit(event)">
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" id="authEmail" placeholder="you@example.com" required>
                            </div>
                            <div class="form-group" id="fullNameGroup" style="display:none;">
                                <label>Full Name</label>
                                <input type="text" id="authName" placeholder="John Doe">
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <div style="position: relative;">
                                    <input type="password" id="authPassword" placeholder="••••••••" required
                                        minlength="6" style="padding-right: 35px;">
                                    <span onclick="togglePasswordVisibility('authPassword', this)"
                                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; opacity: 0.6;">
                                        👁️
                                    </span>
                                </div>
                            </div>

                            <div class="form-group" id="confirmPasswordGroup" style="display:none;">
                                <label>Confirm Password</label>
                                <div style="position: relative;">
                                    <input type="password" id="authConfirmPassword" placeholder="••••••••" minlength="6"
                                        style="padding-right: 35px;">
                                    <span onclick="togglePasswordVisibility('authConfirmPassword', this)"
                                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; opacity: 0.6;">
                                        👁️
                                    </span>
                                </div>
                            </div>

                            <button type="submit" class="btn primary-btn" id="authSubmitBtn" style="width: 100%;">Sign
                                In</button>
                        </form>

                        <div style="text-align: center; margin-top: 15px; font-size: 0.9rem;">
                            <p id="authSwitchText">Don't have an account? <a href="#"
                                    onclick="toggleAuthMode('signup')">Sign Up</a></p>
                            <p id="authForgotText" style="margin-top: 5px;"><a href="#"
                                    onclick="resetPasswordTrigger()">Forgot Password?</a></p>
                        </div>
                    </div>
                </div>
            </div>



        </header>

        <div class="class-selector-section">
            <div class="class-selector-header">
                <h3>📚 Select Your Class</h3>
                <div class="header-actions">
                    <button class="btn primary-btn" onclick="openAddClassModal()"
                        style="padding: 8px 20px; font-size: 0.9rem;">+ Add Class</button>
                    <button class="btn warning-btn" onclick="editSelectedClass()">Edit/Share (Class)</button>
                    <button class="btn danger-btn" onclick="deleteSelectedClass()">Delete Class</button>
                    <button class="btn info-btn" onclick="openPortalSetup()" id="portalBtn">Student Portal</button>

                    <input type="file" id="restoreInput" onchange="restoreData(event)" accept=".json"
                        style="display: none;">
                </div>
                <div class="class-search-wrapper">
                    <input type="text" class="class-search" id="classSearch"
                        placeholder="🔍 Type to search for a class..." oninput="handleSearchInput()"
                        list="class-suggestions">
                    <datalist id="class-suggestions"></datalist>
                </div>
                <select class="class-dropdown" id="classSelector" onchange="handleDropdownChange()"
                    aria-label="Select Class"></select>
            </div>

            <div id="timetableSection" style="display: none;">
                <h3>📅 Weekly Timetable</h3>
                <div class="timetable-wrapper">
                    <div id="timetableGrid" class="timetable-grid"></div>
                </div>
            </div>
            <div id="portalDashboardSection" style="display: none;"></div>

            <!-- Community Dashboard Section -->
            <div id="communityDashboardSection" style="display: none; padding: 20px;">
                <div class="community-header"
                    style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3>👥 Class Community Hub</h3>
                    <button class="btn secondary-btn" onclick="SocialManager.closeCommunityDashboard()">Back to
                        Class</button>
                </div>

                <!-- TAB 1: HUB (Default) -->
                <div id="communityHubTab">
                    <div class="mass-bunk-card"
                        style="background: var(--glass-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--border-color); text-align: center; margin-bottom: 30px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);">
                        <h4 style="color: var(--text-secondary); margin-bottom: 10px; font-weight: 500;">MASS BUNK
                            PROBABILITY (TODAY)</h4>
                        <div id="massBunkMeter"
                            style="font-size: 3rem; font-weight: 800; background: -webkit-linear-gradient(45deg, #1abc9c, #3498db); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            --%
                        </div>
                        <p id="massBunkStatus" style="color: var(--text-primary); margin-top: 5px;">Data loading...</p>
                        <div style="margin-top: 15px; font-size: 0.9rem; color: var(--medium-text);">
                            <span id="activeBunkersCount">0</span> classmates are bunking today
                        </div>
                    </div>

                    <div class="polls-section">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: var(--text-primary);">🗳️ Active Polls</h4>
                            <button class="btn primary-btn" onclick="SocialManager.createPollUI()">+ New Poll</button>
                        </div>
                        <div id="pollsContainer"
                            style="display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                            <!-- Polls will be injected here -->
                            <div
                                style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1/-1;">
                                No active polls. Start one?
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div id="classSelectedContent" style="display: none;">
                    <div class="upload-section" id="uploadSection">
                        <div class="upload-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                stroke-linejoin="round" class="feather feather-upload-cloud">
                                <path d="M16 16l-4-4-4 4M12 12v9"></path>
                                <path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"></path>
                                <path d="M16 16l-4-4-4 4"></path>
                            </svg>
                        </div>
                        <h3>Upload Attendance Screenshot(s)</h3>
                        <p>Drag & drop your file(s) here or click to browse. You can select multiple images.</p>
                        <input type="file" id="imageInput" class="upload-input" accept="image/*" multiple
                            onchange="handleImageUpload(this.files)">
                        <div class="upload-btn-group">
                            <button class="btn primary-btn"
                                onclick="document.getElementById('imageInput').click()">Choose
                                Image(s)</button>
                            <button class="btn secondary-btn" onclick="showInputMode('manual')">Manual
                                Entry</button>
                            <button class="btn secondary-btn" onclick="showInputMode('json')">Paste JSON</button>
                        </div>
                    </div>

                    <div class="preview-section" id="previewSection" style="display: none;">
                        <h4 style="margin-bottom: 15px; color: var(--dark-text);">📸 Uploaded Images Preview:</h4>
                        <div id="previewImagesGrid" class="preview-images-grid"></div>
                    </div>

                    <div class="loading" id="loadingSection">
                        <div class="spinner"></div>
                        <p>Processing image and extracting attendance data...</p>
                    </div>


                    <div class="settings-section">
                        <h3>⚙️ Calculation Settings</h3>
                        <div class="grid-inputs">
                            <div class="input-group">
                                <label for="minAttendanceInput">Minimum Attendance %</label>
                                <input type="number" id="minAttendanceInput" value="75" min="1" max="100"
                                    onchange="validateMedicalSettings(); triggerRecalculation()">
                            </div>
                            <div class="input-group">
                                <label for="minMedicalInput">Min % for Medical</label>
                                <input type="number" id="minMedicalInput" value="65" min="0" max="75"
                                    onchange="validateMedicalSettings(); triggerRecalculation()">
                            </div>
                            <div class="input-group">
                                <label>Calculation Mode</label>
                                <div class="toggle-group" style="margin-top: 10px;">
                                    <span>Per-Subject</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="overallCriteriaCheckbox"
                                            onchange="triggerRecalculation()">
                                        <span class="slider"></span>
                                    </label>
                                    <span>Overall</span>
                                </div>
                            </div>
                            <div class="input-group" style="justify-content: flex-end;">
                                <button class="btn info-btn" onclick="checkSkipToday()">🤔 Can I Skip
                                    Today?</button>
                            </div>
                        </div>
                    </div>

                    <div class="date-section">
                        <h3>📅 Semester Timeline</h3>
                        <div class="grid-inputs">
                            <div class="input-group"><label for="currentDate">Current Date:</label><input type="date"
                                    id="currentDate" onchange="updateDailyDashboard(); triggerRecalculation()"></div>
                            <!-- NEW: Semester Start Date for Accuracy & Shared ID -->
                            <div class="input-group"><label for="startDate">Semester Start Date:</label><input
                                    type="date" id="startDate" onchange="triggerRecalculation()"></div>
                            <div class="input-group"><label for="lastDate">Last Working Date:</label><input type="date"
                                    id="lastDate" onchange="triggerRecalculation()"></div>
                        </div>
                    </div>

                    <!-- Timeline Preview Section for "What-if" calculations -->
                    <div class="date-section" id="timelinePreviewSection" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;"
                            onclick="toggleTimelinePreview()">
                            <h3 style="margin: 0;">🔮 Preview Timeline <span
                                    style="font-size: 0.8rem; color: var(--medium-text);">(What-if calculation)</span>
                            </h3>
                            <span id="timelinePreviewToggle" style="font-size: 1.2rem;">▼</span>
                        </div>
                        <div id="timelinePreviewContent" style="display: none; margin-top: 15px;">
                            <p style="font-size: 0.85rem; color: var(--medium-text); margin-bottom: 15px;">
                                Adjust dates temporarily to see projected calculations. These dates are <strong>NOT
                                    saved</strong>.
                            </p>
                            <div class="grid-inputs">
                                <div class="input-group">
                                    <label for="previewStartDate">Preview Start Date:</label>
                                    <input type="date" id="previewStartDate">
                                </div>
                                <div class="input-group">
                                    <label for="previewEndDate">Preview End Date:</label>
                                    <input type="date" id="previewEndDate">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="btn primary-btn" onclick="calculateWithPreviewDates()" style="flex: 1;">
                                    🔮 Preview Calculation
                                </button>
                                <button class="btn secondary-btn" onclick="resetPreviewDates()" style="flex: 1;">
                                    ↩️ Reset to Actual
                                </button>
                            </div>
                            <div id="previewModeIndicator"
                                style="display: none; margin-top: 10px; padding: 8px 12px; background: linear-gradient(135deg, #9333ea20, #6366f120); border: 1px solid #9333ea; border-radius: 8px; text-align: center; color: #9333ea; font-weight: 500;">
                                ⚡ Viewing Preview Mode - Results based on custom timeline
                            </div>
                        </div>
                    </div>

                    <div class="manual-input" id="manualInput">
                        <h3>📝 Manual Attendance Entry</h3>
                        <div class="subjects-grid" id="subjectsGrid"></div>
                        <button class="calculate-btn" onclick="calculateFromManual()">Calculate Attendance</button>
                    </div>

                    <div class="manual-input" id="jsonInput">
                        <h3>📄 Paste Attendance JSON</h3>
                        <div class="json-instructions">
                            <strong>How to use:</strong>
                            <ol>
                                <li>Click "Copy AI Prompt" and paste it into an AI chat (like Gemini) with your
                                    attendance
                                    screenshot.</li>
                                <li>The AI will generate a JSON code block. Copy it.</li>
                                <li>Paste the JSON into the text box below and click "Calculate".</li>
                            </ol>
                        </div>
                        <button class="btn secondary-btn" onclick="copyAttendanceAIPrompt()"
                            style="width: 100%; margin: 15px 0;">📋 Copy Prompt for AI</button>
                        <div class="form-group">
                            <textarea id="attendanceJsonPasteArea"
                                placeholder='{ "SUBJECT-CODE-1": { "total": 40, "present": 35 }, "SUBJECT-CODE-2": { "total": 42, "present": 30 } }'
                                style="min-height: 150px; font-family: monospace;"></textarea>
                        </div>
                        <button class="calculate-btn" onclick="calculateFromJson()">Calculate from JSON</button>
                    </div>


                    <div class="results-section" id="resultsSection"></div>

                    <div id="pdfDownloadContainer" style="text-align: center; margin-top: 30px;"></div>

                    <div id="leavePlannerSection" style="display: none;"></div>

                    <div id="maxLeaveRecommendation" style="display: none;"></div>

                    <div id="maxPossibleBunkResults" style="display: none;"></div>

                    <div id="medicalLeaveSection" style="display: none; margin-top: 20px;"></div>

                    <div id="leaveRecommendationContainer" style="display: none;">
                        <div class="subject-card" style="border-left-color: var(--info-color);">
                            <div class="subject-title">💡 Long Weekend Finder</div>
                            <p>Find the best time to take leave for the longest possible break.</p>
                            <div class="weekend-finder-controls">
                                <div class="input-group">
                                    <label for="numLeaveDays">Number of leave days to use:</label>
                                    <input type="number" id="numLeaveDays" value="1" min="1" max="10"
                                        style="padding: 10px;">
                                </div>
                                <button class="btn info-btn" onclick="findLongWeekends()" style="margin: 0;">Find
                                    Best
                                    Break</button>
                            </div>
                            <div id="longWeekendFinderResult" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="addClassModal"></div>
        <div class="modal" id="partialEntryModal"></div>
        <div class="modal" id="exportModal"></div>
        <div class="modal" id="skipTodayModal"></div>
        <div class="modal" id="dailyLogModal"></div>
        <div class="modal" id="helpModal"></div>
        <div class="modal" id="donateModal"></div>
        <div class="modal" id="privacyPolicyModal"></div>
        <div class="modal" id="periodAttendanceModal"></div>
        <div class="modal" id="customScheduleModal"></div>
        <div class="modal" id="notificationSettingsModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal('notificationSettingsModal')">&times;</button>
                <div class="modal-header">
                    <h2>🔔 Notification Settings</h2>
                    <p>Get daily reminders to log your attendance</p>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="notificationEnabled" onchange="toggleNotifications(this.checked)"
                            style="width: auto;">
                        <span>Enable Daily Notifications</span>
                    </label>
                </div>
                <div class="form-group" id="notificationTimeGroup" style="display: none;">
                    <label for="notificationTime">Notification Time:</label>
                    <input type="time" id="notificationTime" value="16:30">
                    <p style="font-size: 0.85rem; color: var(--medium-text); margin-top: 5px;">
                        You'll receive a daily reminder to log your attendance at this time (in your local
                        timezone).
                    </p>
                    <p style="font-size: 0.75rem; color: var(--medium-text); margin-top: 5px;" id="timezoneInfo">
                    </p>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn primary-btn" onclick="saveNotificationSettings()">Save Settings</button>
                </div>
            </div>
        </div>
        <div class="modal" id="portalSetupModal"></div>
        <div class="modal" id="historyLogModal"></div>
        <div class="modal" id="backupOptionsModal"></div>
        <div class="modal" id="restoreOptionsModal"></div>
        <div class="modal" id="welcomeModal"></div>
        <div class="modal" id="ocrSettingsModal"></div>

        <!-- AI Chatbot Floating Button -->
        <button id="aiChatbotButton" onclick="openAIChatbot()"
            style="display: flex; border: none; cursor: pointer; align-items: center; justify-content: center;">
            🤖
        </button>

        <!-- AI Chat Panel -->
        <div id="aiChatPanel" class="chat-panel">
            <!-- Chat Header -->
            <div
                style="padding: 15px 20px; background: linear-gradient(135deg, var(--primary-grad-start), var(--primary-grad-end)); color: white; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5rem;">🤖</span>
                    <span style="font-weight: 600; font-size: 1.1rem;">AI Assistant</span>
                </div>
                <button onclick="closeAIChatbot()"
                    style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button>
            </div>

            <!-- FAQ Section -->
            <div class="faq-section">
                <h4>Quick Questions:</h4>
                <div class="faq-buttons">
                    <button class="faq-btn" onclick="askFAQ('How do I add a new class?')">How do I add a new
                        class?</button>
                    <button class="faq-btn" onclick="askFAQ('What is Portal Mode?')">What is Portal Mode?</button>
                    <button class="faq-btn" onclick="askFAQ('How does OCR attendance scanning work?')">How does OCR
                        attendance scanning work?</button>
                    <button class="faq-btn" onclick="askFAQ('How do I get medical leave recommendations?')">How do I get
                        medical leave recommendations?</button>
                    <button class="faq-btn"
                        onclick="askFAQ('What is the difference between upload and manual mode?')">What's the
                        difference between upload and manual mode?</button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 15px;">
                <div class="chat-message system">👋 Hi! I'm here to help you with the app. Ask me anything!</div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Ask about the app..."
                    onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()">Send</button>
            </div>
        </div>

        <script src="js/app.js"></script>
        <!-- Share Class Modal -->
        <div id="shareClassModal" class="modal">
            <div class="modal-content" style="text-align: center;">
                <button class="modal-close" onclick="closeModal('shareClassModal')">&times;</button>
                <div class="modal-header">
                    <h2>📤 Share Class</h2>
                    <p>Scan this QR code to import this class setup on another device.</p>
                </div>
                <div id="qrcode" style="display: inline-block; padding: 20px; background: white; margin: 20px 0;">
                </div>
                <p style="font-size: 0.9rem; color: var(--medium-text); margin-bottom: 20px;">Includes subjects and
                    holidays. Does not include your personal attendance logs.</p>

                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn success-btn" onclick="shareClassLink()">🔗 Share via App Link</button>
                    <button class="btn secondary-btn" onclick="downloadQRImage()">⬇️ Download QR</button>
                </div>
            </div>
        </div>

        <!-- Scan Class Modal -->
        <div id="scanClassModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeScanModal()">&times;</button>
                <div class="modal-header">
                    <h2>📷 Scan Class QR</h2>
                    <p>Point your camera at a class QR code OR upload a QR image.</p>
                </div>

                <!-- File Upload Option -->
                <div style="margin-bottom: 20px; text-align: center;">
                    <input type="file" id="qrInputFile" accept="image/*" style="display: none;"
                        onchange="handleQRFileUploadInTab(this)">
                    <button class="btn secondary-btn" onclick="document.getElementById('qrInputFile').click()">📂
                        Upload
                        QR
                        Image</button>
                </div>

                <script>
                    // ========== SHARE FUNCTIONALITY ==========
                    async function shareClassLink() {
                        if (!selectedClass) {
                            showToast('❌ Please select a class first', 'error');
                            return;
                        }

                        // Prepare class data (clean structure)
                        const classData = {
                            name: selectedClass.name,
                            lastDate: selectedClass.lastDate, // Added for strict duplicate check
                            subjects: selectedClass.subjects || [],
                            holidays: selectedClass.holidays || [],
                            timetable: selectedClass.timetable || {},
                            periodTimes: selectedClass.periodTimes || {}
                        };

                        // Encode data
                        // Compression v2
                        const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(classData));
                        const encodedData = 'v2_' + compressed;

                        // Get base URL (works for subdirectories too)
                        const baseUrl = window.location.href.split('?')[0].split('#')[0];
                        const shareUrl = `${baseUrl}?class=${encodedData}`;

                        // Check URL length - warn if too long for some platforms
                        if (shareUrl.length > 2000) {
                            console.warn(`Share URL length: ${shareUrl.length} chars (may be too long for some platforms)`);
                            if (shareUrl.length > 8000) {
                                showToast('⚠️ Class data is very large. Link may not work on all platforms.', 'warning');
                            }
                        }

                        const shareData = {
                            title: 'Join my Class on Bunkit',
                            text: `Hey! I'm using Bunkit to track attendance. Here's our class setup for ${classData.name}. Click to import subjects and timetable:\n\n`,
                            url: shareUrl
                        };

                        // Use Web Share API if available
                        if (navigator.share) {
                            try {
                                await navigator.share(shareData);
                                showToast('✅ Link shared successfully!', 'success');
                            } catch (err) {
                                if (err.name !== 'AbortError') {
                                    console.error('Share failed:', err);
                                    // Fallback to clipboard
                                    copyShareLinkToClipboard(shareUrl);
                                }
                            }
                        } else {
                            // Fallback to clipboard
                            copyShareLinkToClipboard(shareUrl);
                        }
                    }

                    function copyShareLinkToClipboard(text) {
                        // Try modern Clipboard API first
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(text).then(() => {
                                alert('🔗 Link copied to clipboard!\n\nYou can now paste and share it.');
                            }).catch(() => {
                                // Fallback for iOS Safari and older browsers
                                copyToClipboardFallback(text);
                            });
                        } else {
                            // Fallback for browsers without Clipboard API
                            copyToClipboardFallback(text);
                        }
                    }

                    // iOS-compatible clipboard fallback using execCommand
                    function copyToClipboardFallback(text) {
                        const textArea = document.createElement('textarea');
                        textArea.value = text;

                        // iOS Safari requires specific styling
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-9999px';
                        textArea.style.top = '0';
                        textArea.style.opacity = '0';
                        textArea.setAttribute('readonly', ''); // Prevent zoom on iOS

                        document.body.appendChild(textArea);

                        // iOS Safari requires this specific selection approach
                        const range = document.createRange();
                        range.selectNodeContents(textArea);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                        textArea.setSelectionRange(0, text.length); // For older iOS

                        try {
                            const successful = document.execCommand('copy');
                            if (successful) {
                                alert('🔗 Link copied to clipboard!\n\nYou can now paste and share it.');
                            } else {
                                // Show link for manual copy
                                prompt('Copy this link manually:', text);
                            }
                        } catch (err) {
                            // Show link for manual copy
                            prompt('Copy this link manually:', text);
                        }

                        document.body.removeChild(textArea);
                    }

                    function downloadQRImage() {
                        const qrContainer = document.getElementById('qrcode');
                        const canvas = qrContainer.querySelector('canvas');
                        const img = qrContainer.querySelector('img');
                        const source = canvas || img;

                        if (!source) {
                            showToast('❌ No QR code generated', 'error');
                            return;
                        }

                        const link = document.createElement('a');
                        link.download = `Bunkit_Class_${selectedClass ? selectedClass.name : 'Share'}.png`;
                        link.href = source.src || source.toDataURL();
                        link.click();
                    }

                    // ========== HYBRID OCR SYSTEM ==========

                    // Gemini API Key - Uses personal key or backend proxy
                    // Gemini API Key - Uses personal key or backend proxy
                    // Get your own key from: https://aistudio.google.com/app/apikey
                    // Personal key is loaded dynamically
                    const GEMINI_DAILY_LIMIT = 10000;


                    // Test shared API key (for debugging)
                    // Test shared API key (for debugging)
                    async function testSharedAPIKey() {
                        const sharedKeys = getFallbackSharedKeys();
                        const keyToTest = sharedKeys[0] || 'NO_KEY_FOUND';

                        console.log('🧪 Testing Shared Gemini API Key...');
                        console.log('🔑 Key(s) available:', sharedKeys.length);

                        try {
                            // First, list available models to see what's valid
                            console.log('📋 Listing available models...');
                            const listResponse = await
                                fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${keyToTest}`);

                            if (listResponse.ok) {
                                const listData = await listResponse.json();
                                console.log('✅ Available Models:', listData);
                                const flashModel = listData.models?.find(m => m.name.includes('flash'));
                                if (flashModel) {
                                    console.log('✨ Found Flash Model:', flashModel.name);
                                } else {
                                    console.warn('⚠️ No "flash" model found in list!');
                                }
                            } else {
                                const err = await listResponse.text();
                                console.error('❌ Model list failed:', listResponse.status, err);
                            }
                        } catch (e) {
                            console.error('Test failed:', e);
                        }
                    }


                    // Make testSharedAPIKey available globally for console testing
                    window.testSharedAPIKey = testSharedAPIKey;

                    // === QUOTA TRACKING (Updated for Personal Keys) ===
                    function getGeminiQuota(type = 'shared') {
                        const quotaData = JSON.parse(localStorage.getItem(`geminiQuota_${type}`) || '{}');
                        const today = new Date().toDateString();

                        if (quotaData.date !== today) {
                            // New day, reset quota
                            return { date: today, count: 0, limit: GEMINI_DAILY_LIMIT };
                        }

                        return quotaData;
                    }

                    function incrementGeminiQuota(type = 'shared') {
                        const quota = getGeminiQuota(type);
                        quota.count += 1;
                        localStorage.setItem(`geminiQuota_${type}`, JSON.stringify(quota));
                        console.log(`📊 ${type} quota: ${quota.count}/${quota.limit}`);
                        return quota;
                    }

                    function hasGeminiQuotaRemaining(type = 'shared', apiKey = null) {
                        if (!apiKey || apiKey === 'YOUR_GEMINI_API_KEY_HERE') {
                            console.log(`⚠️ No ${type} API key configured`);
                            return false;
                        }
                        const quota = getGeminiQuota(type);
                        return quota.count < quota.limit;
                    }

                    // === GEMINI API PROCESSOR ===
                    async function processImageWithGemini(imageFile, apiKey) {
                        console.log('🤖 Processing with Gemini API...');

                        // Convert image to base64
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                const base64data = reader.result.split(',')[1];
                                resolve(base64data);
                            };
                            reader.readAsDataURL(imageFile);
                        });

                        // Construct subject list for context
                        let subjectContext = "";
                        if (selectedClass && selectedClass.subjects) {
                            subjectContext = selectedClass.subjects.map(s => `- "${s.code}": ${s.name}`).join('\n');
                        }

                        const prompt = `Analyze this university/college attendance screenshot and extract the attendance
                    data.

                    CONTEXT - The student is enrolled in these specific subjects:
                    ${subjectContext}

                    IMPORTANT: Return ONLY a valid JSON object in this exact format (no markdown, no explanations):
                    {
                    "SUBJECT-CODE-1": { "total": 50, "present": 45 },
                    "SUBJECT-CODE-2": { "total": 48, "present": 40 }
                    }

                    Rules:
                    1. Keys MUST be the exact subject codes from the list above.
                    2. "total" = total classes held
                    3. "present" = classes attended
                    4. If a subject code in the image is slightly different (e.g., missing a letter), map it to the
                    closest matching code from the list above.
                    5. Return ONLY the JSON, nothing else`;


                        // 1. Determine Key Source
                        const effectiveKey = apiKey || getPersonalGeminiKey();

                        if (!effectiveKey) {
                            throw new Error('No API key available for Gemini processing');
                        }

                        // Construct prompt & contents common to both methods
                        const generationBody = {
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    {
                                        inline_data: {
                                            mime_type: imageFile.type,
                                            data: base64
                                        }
                                    }
                                ]
                            }]
                        };

                        let response;

                        try {
                            // CASE A: Direct Fetch with Effective Key
                            // console.log('🔑 Using Gemini Key'); // Verbose
                            response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${effectiveKey}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(generationBody)
                            });
                        } catch (netErr) {
                            throw new Error(`Network error calling Gemini: ${netErr.message}`);
                        }

                        console.log('📡 Gemini API Response Status:', response.status);

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('❌ Gemini API Error Response:', errorText);

                            // Check for common errors
                            if (response.status === 400) {
                                throw new Error(`Invalid API request. Check if API key is correct.`);
                            } else if (response.status === 403) {
                                throw new Error(`API key denied. Please verify your key at Google AI Studio.`);
                            } else if (response.status === 429) {
                                console.warn('⚠️ Gemini Quota Exceeded (429)');
                                throw new Error(`Quota exceeded. Daily limit: 10,000 requests.`);
                            } else {
                                throw new Error(`Gemini API error: ${response.status} - ${errorText}`);
                            }
                        }

                        const data = await response.json();
                        console.log('📦 Gemini API Raw Response:', data);

                        // Check if response has expected structure
                        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                            console.error('❌ Unexpected response structure:', data);
                            throw new Error('Invalid response from Gemini API');
                        }

                        const textResponse = data.candidates[0].content.parts[0].text;
                        console.log('📝 Gemini Text Response:', textResponse);

                        // Extract JSON from response (in case it's wrapped in markdown)
                        const jsonMatch = textResponse.match(/\{[\s\S]*\}/);
                        if (!jsonMatch) {
                            console.error('❌ No JSON found in response:', textResponse);
                            throw new Error('No JSON found in Gemini response');
                        }

                        const attendanceData = JSON.parse(jsonMatch[0]);
                        console.log('✅ Gemini extraction successful:', attendanceData);

                        return attendanceData;
                    }

                    // === TESSERACT FALLBACK ===
                    async function processImageWithTesseract(imageFile) {
                        console.log('📄 Processing with Tesseract (offline)...');
                        // Lazy-load Tesseract library
                        try { await window.loadScript('https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js'); } catch (e) {
                            console.error('Failed to load Tesseract library:', e);
                            throw new Error('Tesseract library failed to load. Check your internet connection.');
                        }

                        const { data: { text } } = await Tesseract.recognize(imageFile, 'eng', {
                            logger: m => console.log(m)
                        });

                        console.log('OCR Text:', text);

                        // Parse text to extract attendance data
                        const lines = text.split('\n').filter(line => line.trim());
                        const attendanceData = {};

                        // Simple parsing: look for patterns like "CODE 45/50" or "CODE 45 50"
                        for (const line of lines) {
                            // Pattern: SUBJECT-CODE followed by numbers
                            const match = line.match(/([A-Z0-9-]+)\s+(\d+)\s*[\/\s]\s*(\d+)/);
                            if (match) {
                                const [, code, present, total] = match;
                                attendanceData[code] = {
                                    total: parseInt(total),
                                    present: parseInt(present)
                                };
                            }
                        }

                        if (Object.keys(attendanceData).length === 0) {
                            throw new Error('Could not extract attendance data from text');
                        }

                        console.log('✅ Tesseract extraction successful:', attendanceData);
                        return attendanceData;
                    }

                    // === HYBRID PROCESSOR (Main Entry Point) - 3-Tier Fallback ===


                    // Helper to get shared keys (Obfuscated to prevent casual scraping)
                    function getFallbackSharedKeys() {
                        const obfuscatedKeys = [
                            'QUl6YVN5Q1F6ck9yVG5NUjFlbGFlZUNNcmxubUttSzdnaGtxZXRv',
                            'QUl6YVN5QjFxQk8xMzNHMnBoWVgwOVBTMFdPSjZ4WnFxY1Bydlo0',
                            'QUl6YVN5QzQxVnZJbFVoR1FwcjJ5eDB3SzNacHVFVkV6STJDSkNB'
                        ];
                        try {
                            return obfuscatedKeys.map(k => atob(k)).filter(k => k.startsWith('AIza'));
                        } catch (e) {
                            console.error('Failed to decode keys:', e);
                            return [];
                        }
                    }

                    // === HYBRID PROCESSOR (Main Entry Point) - 3-Tier Fallback ===

                    async function processAttendanceImage(imageFile, showProgress = true) {
                        try {
                            // TIER 1: Try Personal Gemini API Key (if available)
                            const personalKey = localStorage.getItem('personalGeminiKey');
                            if (personalKey && hasGeminiQuotaRemaining('personal', personalKey)) {
                                const personalQuota = getGeminiQuota('personal');
                                if (showProgress) {
                                    console.log(`🤖 Processing with YOUR Gemini API (${personalQuota.count}/${personalQuota.limit} today)...`);
                                }

                                try {
                                    const result = await processImageWithGemini(imageFile, personalKey);
                                    incrementGeminiQuota('personal');
                                    return { data: result, method: 'Your Gemini AI', success: true };
                                } catch (geminiError) {
                                    console.error('Personal Gemini failed:', geminiError);
                                    // Continue to Tier 2
                                }
                            }

                            // TIER 2: Try Shared Gemini API (Obfuscated Keys)
                            const sharedQuota = getGeminiQuota('shared');
                            const sharedKeys = getFallbackSharedKeys();

                            // Check if keys exist and quota is remaining
                            if (sharedKeys.length > 0 && sharedQuota.count < sharedQuota.limit) {
                                if (showProgress) {
                                    console.log(`🤖 Processing with Shared Gemini AI (${sharedQuota.count}/${sharedQuota.limit} today)...`);
                                }

                                // Try keys in rotation/sequence
                                for (let i = 0; i < sharedKeys.length; i++) {
                                    const key = sharedKeys[i];
                                    try {
                                        console.log(`🔄 Attempting shared key ${i + 1}/${sharedKeys.length}`);
                                        const result = await processImageWithGemini(imageFile, key);
                                        incrementGeminiQuota('shared');
                                        return { data: result, method: 'Shared Gemini AI', success: true };
                                    } catch (geminiError) {
                                        console.warn(`❌ Shared Key ${i + 1} failed:`, geminiError.message);
                                        // Try next key
                                    }
                                }
                                console.warn('⚠️ All shared keys failed.');
                            } else {
                                console.warn('⚠️ Shared Gemini quota exceeded or no keys available.');
                            }

                            // TIER 3: Use Tesseract Fallback
                            if (showProgress) {
                                console.log('📄 Using offline OCR (Tesseract)...');
                            }

                            const result = await processImageWithTesseract(imageFile);
                            return { data: result, method: 'Offline OCR', success: true };

                        } catch (error) {
                            console.error('❌ ALL OCR methods failed:', error);

                            // Show error with option to add personal key
                            const personalKey = localStorage.getItem('personalGeminiKey');
                            if (!personalKey) {
                                const addKey = confirm(`❌ OCR Processing Failed\n\n${error.message}\n\nBoth shared AI quota and
                    offline OCR failed.\n\nWould you like to add your FREE personal Gemini API key?\n(10,000
                    requests/day, completely free)`);

                                if (addKey) {
                                    openOCRSettings();
                                }
                            } else {
                                // Call the portal error handler
                                showPortalImageError(error.message);
                            }

                            return { data: null, method: null, success: false, error: error.message };
                        }
                    }

                    // Portal Image Processing Error Handler
                    function showPortalImageError(errorMessage) {
                        const message = `❌ Unable to process attendance portal image.

                    ${errorMessage || 'The OCR model could not extract attendance data from your screenshot.'}

                    📸 Help us improve!
                    Please share your attendance portal screenshot with the developer so we can train the OCR model for
                    your college/school portal.

                    Would you like to contact the developer now via WhatsApp?`;

                        const userWantsToContact = confirm(message);

                        if (userWantsToContact) {
                            // Open WhatsApp chat with developer
                            const whatsappUrl =
                                'https://wa.me/916386854875?text=Hi!%20I%20need%20help%20with%20OCR%20processing%20in%20Bunk%20it%20app.%20My%20portal%20screenshot%20could%20not%20be%20processed.';
                            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                        }

                        // Optional: Auto-highlight WhatsApp button temporarily
                        const whatsappBtn = document.querySelector('.whatsapp-float');
                        if (whatsappBtn) {
                            whatsappBtn.style.animation = 'pulse 2s 3';
                            setTimeout(() => {
                                whatsappBtn.style.animation = '';
                            }, 6000);
                        }
                    }
                    // === AI CLASS IMPORT FEATURE ===

                    function updateAIFileCount(input) {
                        const count = input.files.length;
                        const display = document.getElementById('aiFileCount');
                        if (count > 0) {
                            display.textContent = `✅ ${count} file(s) selected`;
                        } else {
                            display.textContent = '';
                        }
                    }

                    async function handleAIClassImport() {
                        const fileInput = document.getElementById('aiImportFiles');
                        const textInput = document.getElementById('aiImportText').value;
                        const loadingDiv = document.getElementById('aiImportLoading');

                        if (fileInput.files.length === 0 && !textInput.trim()) {
                            alert("Please upload a file or enter some text details.");
                            return;
                        }

                        loadingDiv.style.display = 'block';

                        try {
                            // 1. Prepare Images
                            const imageParts = [];
                            for (const file of fileInput.files) {
                                const base64 = await new Promise((resolve) => {
                                    const reader = new FileReader();
                                    reader.onloadend = () => {
                                        if (reader.result) {
                                            resolve(reader.result.split(',')[1]);
                                        } else {
                                            console.error("FileReader result is null/empty for file:", file.name);
                                            resolve(null);
                                        }
                                    };
                                    reader.readAsDataURL(file);
                                });
                                if (base64) {
                                    imageParts.push({
                                        inlineData: {
                                            data: base64,
                                            mimeType: file.type
                                        }
                                    });
                                }
                            }

                            // 2. Prepare Prompt
                            const promptText = `
                    Analyze the attached images (timetable, attendance screenshot, etc.) and the text below to extract
                    class details.

                    USER NOTES: "${textInput}"

                    Generate a JSON structure for a weekly class timetable.

                    **Global Fields:**
                    * Include \`lastDate\` (validity as YYYY-MM-DD), a list of \`holidays\` (array of YYYY-MM-DD strings), and a \`qrCode\` string (for export/sharing - use empty string).

                    **Subjects Array:**
                    * The structure must **not** include a separate \`timetableArrangement\` object. All scheduling logic belongs inside \`subjects\`.
                    * Each subject object must contain: \`name\`, \`code\`, \`shortName\`, and \`schedule\`.

                    **Schedule Logic:**
                    * The \`schedule\` key must be an array of 7 strings (representing days 0-6, Mon-Sun).
                    * Use the period number as a string (e.g., "1").
                    * If a subject occupies multiple periods on one day, separate them with commas (e.g., "2,3").
                    * If there is no class, use "0".

                    EXACT JSON STRUCTURE:
                    {
                      "CLASS NAME": {
                        "lastDate": "YYYY-MM-DD",
                        "qrCode": "",
                        "holidays": ["YYYY-MM-DD", "YYYY-MM-DD"],
                        "subjects": [
                          {
                            "name": "Full Subject Name",
                            "shortName": "ABBR",
                            "code": "SUBJECT-CODE",
                            "schedule": ["1", "1,2", "0", "3", "0", "0", "0"]
                          }
                        ]
                      }
                    }

                    CRITICAL INSTRUCTIONS:
                    1. The top-level key MUST be the class name (e.g., "CSE Core - H").
                    2. 'lastDate' is the single last working day of the semester.
                    3. 'holidays' is an array of date strings for all holiday dates.
                    4. For 'shortName', use a short abbreviation (2-5 characters) like "DS&A", "OS", "CO&A".
                    5. The 'schedule' array represents Mon(0) to Sun(6). Use period numbers as strings.
                    6. Merge 'Theory' and 'Lab' sessions of the same subject into a SINGLE subject entry with a combined schedule. (e.g., "Physics" and "Physics Lab" must be one subject).
                    7. If an 'Attendance Detail' image is provided, ONLY include subjects listed there. Ignore general electives from the timetable that the student doesn't take.
                    8. Order the subjects in the 'subjects' array EXACTLY as they appear in the attendance screenshot (top to bottom).
                    9. Provide ONLY the JSON code block in your response, with no extra text.
                    `;

                            // 3. Call Gemini API (Secure Rotation)
                            const requestBody = {
                                contents: [{
                                    parts: [
                                        { text: promptText },
                                        ...imageParts
                                    ]
                                }]
                            };

                            let response;
                            let lastError;

                            // Determine API Keys to use
                            const keysToUse = [];
                            const personalKey = localStorage.getItem('personalGeminiKey');

                            if (personalKey) {
                                // Priority 1: Personal Key
                                keysToUse.push(personalKey);
                                console.log('🔑 Using Personal Gemini Key');
                            } else {
                                // Priority 2: Shared Keys (Obfuscated)
                                keysToUse.push(...getFallbackSharedKeys());
                                console.log('🔄 Using Shared Keys');
                            }

                            if (keysToUse.length === 0) {
                                throw new Error("No API keys available.");
                            }

                            // Try keys in rotation
                            for (let i = 0; i < keysToUse.length; i++) {
                                const currentKey = keysToUse[i];
                                try {
                                    console.log(`Attempting Key ${i + 1}/${keysToUse.length}`);
                                    response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${currentKey}`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(requestBody)
                                    });

                                    // If Quota Exceeded (429), try next key
                                    if (response.status === 429) {
                                        console.warn(`Key ${i + 1} exhausted (429). Rotating...`);
                                        lastError = `Quota exceeded for key ${i + 1}`;
                                        continue;
                                    }

                                    if (response.ok) break; // Success!

                                } catch (e) {
                                    console.error(`Key ${i + 1} failed:`, e);
                                    lastError = e.message;
                                }
                            }

                            if (!response || !response.ok) {
                                throw new Error('All API keys failed. ' + (lastError || ''));
                            }

                            const data = await response.json();

                            if (!response.ok) throw new Error(data.error?.message || 'API Error');

                            const textResponse = data.candidates[0].content.parts[0].text;
                            const jsonMatch = textResponse.match(/\{[\s\S]*\}/);

                            if (!jsonMatch) throw new Error("Could not parse JSON from AI response.");

                            let classData = JSON.parse(jsonMatch[0]);

                            // Fix for nested structure { "ClassName": { ... } }
                            if (!classData.className) {
                                const keys = Object.keys(classData);
                                if (keys.length === 1 && typeof classData[keys[0]] === 'object') {
                                    const possibleClassName = keys[0];
                                    const nestedData = classData[possibleClassName];
                                    // Verify it looks like our class data
                                    if (nestedData.subjects || nestedData.lastDate) {
                                        classData = { ...nestedData, className: possibleClassName };
                                    }
                                }
                            }

                            // GENERATE TIMETABLE ARRANGEMENT & SANITIZE SCHEDULE
                            // Detect if schedule uses new string format (e.g. "1,2")
                            const isNewFormat = classData.subjects && classData.subjects.some(sub =>
                                sub.schedule && sub.schedule.some(val => typeof val === 'string' && val.includes(','))
                            );

                            if (isNewFormat) {
                                console.log("AI Import: Detected new string-based schedule format. Generating timetable arrangement...");
                                let arrangement = {};
                                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

                                // Calculate max periods
                                let maxPeriods = 0;
                                classData.subjects.forEach(subject => {
                                    if (Array.isArray(subject.schedule)) {
                                        subject.schedule.forEach(daySchedule => {
                                            if (daySchedule && daySchedule !== '0') {
                                                const periods = String(daySchedule).split(',').map(p => parseInt(p.trim())).filter(p => !isNaN(p));
                                                if (periods.length > 0) maxPeriods = Math.max(maxPeriods, Math.max(...periods));
                                            }
                                        });
                                    }
                                });

                                // Build arrangement
                                days.forEach((dayName, dayIndex) => {
                                    arrangement[dayIndex] = Array(maxPeriods).fill(null);
                                    classData.subjects.forEach(subject => {
                                        if (subject.schedule && subject.schedule[dayIndex] && subject.schedule[dayIndex] !== '0') {
                                            const periods = String(subject.schedule[dayIndex]).split(',').map(p => parseInt(p.trim())).filter(p => !isNaN(p) && p > 0);
                                            periods.forEach(periodNum => {
                                                if (periodNum > 0 && periodNum <= maxPeriods) {
                                                    arrangement[dayIndex][periodNum - 1] = subject.code;
                                                }
                                            });
                                        }
                                    });
                                    // Clean up trailing nulls
                                    while (arrangement[dayIndex].length > 0 && arrangement[dayIndex][arrangement[dayIndex].length - 1] === null) {
                                        arrangement[dayIndex].pop();
                                    }
                                });

                                // Store in global temp variable for save
                                tempTimetableArrangement = arrangement;

                                // Convert schedule to counts for form
                                classData.subjects = classData.subjects.map(subj => {
                                    const newSchedule = subj.schedule.map(val => {
                                        if (typeof val === 'string') {
                                            if (val === '0' || !val.trim()) return 0;
                                            return val.split(',').filter(p => p.trim() && p.trim() !== '0').length;
                                        }
                                        return typeof val === 'number' ? val : 0;
                                    });
                                    return { ...subj, schedule: newSchedule };
                                });
                            } else {
                                // Clear temp arrangement if not new format
                                tempTimetableArrangement = null;
                            }

                            // 4. Populate Form
                            populateClassFormFromJSON(classData);

                            // 5. Switch to Form Tab & Notify
                            loadingDiv.style.display = 'none';
                            switchModalTab('form');
                            alert("✨ Class Setup Generated!\\n\\nPlease VERIFY the 'Weekly Schedule' for each subject carefully before saving.");

                        } catch (error) {
                            console.error("AI Import Error:", error);
                            loadingDiv.style.display = 'none';
                            alert(`AI Import Failed: ${error.message}`);
                        }
                    }

                    function populateClassFormFromJSON(data) {
                        if (data.className) document.getElementById('newClassName').value = data.className;
                        if (data.lastDate) document.getElementById('newClassLastDate').value = data.lastDate;

                        // Clear existing subjects
                        document.getElementById('subjectsContainer').innerHTML = '';

                        if (data.subjects && Array.isArray(data.subjects)) {
                            data.subjects.forEach(sub => {
                                addSubjectEntry({ name: sub.name, code: sub.code, schedule: sub.schedule });
                            });
                        }

                        // Add holidays
                        const holidayList = document.getElementById('holidayList');
                        holidayList.innerHTML = ''; // Clear existing
                        if (data.holidays && Array.isArray(data.holidays)) {
                            data.holidays.forEach(date => {
                                const li = document.createElement('li');
                                li.innerHTML = `<span>${date}</span><button type="button" class="remove-holiday-btn" onclick="this.parentElement.remove()">Remove</button>`;
                                li.dataset.date = date;
                                holidayList.appendChild(li);
                            });
                        }
                    }

                    // === CHATBOT API - Uses Backend Proxy ===
                    // Chatbot now uses backend proxy with key rotation
                    // Personal key takes priority if set

                    // Stub functions for backward compatibility
                    function getExhaustedChatbotKeys() {
                        return { date: new Date().toDateString(), keys: [] };
                    }

                    function markChatbotKeyExhausted(keyIndex) {
                        console.log('Chatbot keys handled by backend proxy');
                    }

                    function getNextAvailableChatbotKey() {
                        // Backend proxy handles all shared key rotation
                        return { key: null, index: -1, useProxy: true };
                    }

                    // Key is now loaded from js/env-config.js (generated at build time)
                    // If file is missing (dev mode), window.SHARED_CHATBOT_KEY will be undefined.



                    // === AI CHATBOT FUNCTIONS ===

                    // Check if personal API key exists and show/hide chatbot button
                    function toggleChatbotVisibility() {
                        // Always show chatbot - everyone gets 10 questions/day with shared key
                        const chatbotBtn = document.getElementById('aiChatbotButton');
                        if (chatbotBtn) {
                            chatbotBtn.style.display = 'flex';
                        }
                    }

                    // Call on page load
                    window.addEventListener('load', toggleChatbotVisibility);

                    // Open AI Chatbot (closes all modals first during onboarding)
                    window.openAIChatbot = function () {
                        try {
                            // Remove glow from bot icon and HIDE it
                            const botBtn = document.getElementById('aiChatbotButton');
                            if (botBtn) {
                                botBtn.classList.remove('glowing-pulse');
                                botBtn.style.display = 'none';  // Hide when panel opens
                            }

                            // Close any bunkmate tutorial cloud messages (Priority)
                            const tutorialOverlay = document.getElementById('bunkmateTutorialOverlay');
                            if (tutorialOverlay) tutorialOverlay.remove();

                            // Close onboarding/other modals
                            const onboardingModal = document.getElementById('onboardingClassModal');
                            if (onboardingModal && onboardingModal.classList.contains('active') && typeof closeModal === 'function') {
                                closeModal('onboardingClassModal');
                            }

                            document.querySelectorAll('.modal.active').forEach(modal => {
                                modal.classList.remove('active');
                            });

                            // Open chatbot panel - FORCE visibility with inline styles
                            const panel = document.getElementById('aiChatPanel');
                            if (panel) {
                                panel.classList.add('active');
                                panel.style.right = '0';
                                panel.style.display = 'flex';
                                panel.style.zIndex = '2147483647';
                            }

                            // Show backdrop overlay to block background interactions
                            const backdrop = document.getElementById('appBackdrop');
                            if (backdrop) {
                                backdrop.classList.add('active');
                            }
                            document.body.classList.add('backdrop-active');
                        } catch (err) {
                            console.error('Error opening chatbot:', err);
                            // Fallback: force open the panel
                            const panel = document.getElementById('aiChatPanel');
                            if (panel) {
                                panel.classList.add('active');
                                panel.style.right = '0';
                                panel.style.display = 'flex';
                                panel.style.zIndex = '2147483647';
                            }
                        }
                    }

                    // Close AI Chatbot
                    function closeAIChatbot() {
                        const panel = document.getElementById('aiChatPanel');
                        if (panel) {
                            panel.classList.remove('active');
                            panel.style.right = '';  // Reset to CSS default
                            panel.style.zIndex = '';  // Reset to CSS default
                        }
                        // Show the floating button again
                        const botBtn = document.getElementById('aiChatbotButton');
                        if (botBtn) botBtn.style.display = 'flex';

                        // Hide backdrop overlay
                        const backdrop = document.getElementById('appBackdrop');
                        if (backdrop) {
                            backdrop.classList.remove('active');
                        }
                        document.body.classList.remove('backdrop-active');
                    }

                    // Close all panels (called when backdrop is clicked)
                    function closeAllPanels() {
                        // Close chatbot
                        closeAIChatbot();

                        // Close side navigation
                        if (typeof closeNav === 'function') {
                            closeNav();
                        }

                        // Close all modals
                        document.querySelectorAll('.modal.active').forEach(modal => {
                            modal.classList.remove('active');
                        });

                        // Hide backdrop
                        const backdrop = document.getElementById('appBackdrop');
                        if (backdrop) {
                            backdrop.classList.remove('active');
                        }
                        document.body.classList.remove('backdrop-active');
                    }

                    // Expose chatbot functions globally for onclick handlers
                    window.openAIChatbot = openAIChatbot;
                    window.closeAIChatbot = closeAIChatbot;
                    window.closeAllPanels = closeAllPanels;

                    // Add direct event listener for bot icon (works even after DOM move)
                    // Uses both getElementById and stored reference for reliability
                    document.addEventListener('click', function (e) {
                        // Try stored reference first (guaranteed to be the visible one)
                        const botBtn = window._bunkmateBot || document.getElementById('aiChatbotButton');
                        if (!botBtn) return;

                        // Get bot button position and check if click is within its bounds
                        const rect = botBtn.getBoundingClientRect();
                        const clickX = e.clientX;
                        const clickY = e.clientY;

                        // Skip if rect has no size (element not visible/positioned)
                        if (rect.width === 0 || rect.height === 0) {
                            return;
                        }

                        const isWithinBotBtn = (
                            clickX >= rect.left &&
                            clickX <= rect.right &&
                            clickY >= rect.top &&
                            clickY <= rect.bottom
                        );

                        if (isWithinBotBtn) {
                            e.preventDefault();
                            e.stopPropagation();
                            openAIChatbot();
                        }
                    }, true);

                    // Ask FAQ question
                    function askFAQ(question) {
                        const input = document.getElementById('chatInput');
                        input.value = question;
                        sendChatMessage();
                    }

                    // Send chat message
                    // Send chat message
                    async function sendChatMessage() {
                        console.log("Submit button clicked");
                        let input = document.getElementById('chatInput');
                        if (!input) input = document.getElementById('aiChatInput'); // Try alternate ID
                        if (!input) input = document.querySelector('.chat-input-container input'); // Try class selector

                        if (!input) {
                            console.error("Chat input not found! Check IDs.");
                            alert("Error: Chat input field not found. Please reload.");
                            return;
                        }

                        const message = input.value.trim();
                        console.log("Sending message:", message);

                        if (!message) return;

                        // Add user message to chat
                        addChatMessage(message, 'user');
                        input.value = '';

                        // Show thinking indicator
                        addChatMessage('Thinking...', 'system');

                        try {
                            // Get AI response
                            const response = await getAIResponse(message);

                            // Remove thinking indicator
                            removeLastSystemMessage();

                            // Add AI response
                            addChatMessage(response, 'bot');
                        } catch (error) {
                            removeLastSystemMessage();
                            addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
                            console.error('Chat error:', error);
                        }

                        // Scroll to bottom
                        scrollChatToBottom();
                    }

                    // Send AI chat message (from AI Chat Panel with separate input)
                    async function sendAIChatMessage() {
                        const aiInput = document.getElementById('aiChatInput');
                        const chatInput = document.getElementById('chatInput');

                        // Copy value to main chatInput for the existing function to use
                        if (aiInput && chatInput) {
                            chatInput.value = aiInput.value;
                            aiInput.value = '';
                        }

                        // Call the existing function
                        sendChatMessage();
                    }

                    // Add message to chat
                    function addChatMessage(text, type) {
                        const messagesDiv = document.getElementById('chatMessages');
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${type}`;
                        messageDiv.textContent = text;
                        messagesDiv.appendChild(messageDiv);
                    }

                    // Remove last system message
                    function removeLastSystemMessage() {
                        const messagesDiv = document.getElementById('chatMessages');
                        const systemMessages = messagesDiv.querySelectorAll('.chat-message.system');
                        if (systemMessages.length > 1) {
                            systemMessages[systemMessages.length - 1].remove();
                        }
                    }

                    // Scroll chat to bottom
                    function scrollChatToBottom() {
                        const messagesDiv = document.getElementById('chatMessages');
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }

                    // Expose chatbot functions globally for onclick handlers
                    window.sendChatMessage = sendChatMessage;
                    window.askFAQ = askFAQ;

                    // Shared key quota tracking (10 questions/day)
                    function getSharedQuota() {
                        const quotaData = JSON.parse(localStorage.getItem('sharedChatbotQuota') || '{}');
                        const today = new Date().toDateString();

                        if (quotaData.date !== today) {
                            return { date: today, count: 0, limit: 10 };
                        }
                        return quotaData;
                    }

                    function updateSharedQuota() {
                        const quota = getSharedQuota();
                        quota.count++;
                        localStorage.setItem('sharedChatbotQuota', JSON.stringify(quota));
                        return quota;
                    }

                    function hasSharedQuotaRemaining() {
                        const quota = getSharedQuota();
                        return quota.count < quota.limit;
                    }

                    // Get AI response using Gemini API (10 questions/day)


                    // Shared key quota tracking (10 questions/day)
                    function getSharedQuota() {
                        const quotaData = JSON.parse(localStorage.getItem('sharedChatbotQuota') || '{}');
                        const today = new Date().toDateString();

                        if (quotaData.date !== today) {
                            return { date: today, count: 0, limit: 10 };
                        }
                        return quotaData;
                    }

                    function updateSharedQuota() {
                        const quota = getSharedQuota();
                        quota.count++;
                        localStorage.setItem('sharedChatbotQuota', JSON.stringify(quota));
                        return quota;
                    }

                    // Get AI response using Gemini API - Uses backend proxy with key rotation
                    async function getAIResponse(userQuestion) {
                        const personalKey = localStorage.getItem('personalGeminiKey');

                        // Get current date info
                        const today = new Date();
                        const todayStr = formatLocalDate(today);
                        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                        const currentDayName = dayNames[today.getDay()];

                        // Get comprehensive user data
                        const attendanceLogs = JSON.parse(localStorage.getItem('attendance_logs') || '{}');
                        const notificationSettings = JSON.parse(localStorage.getItem('notificationSettings') || '{"enabled":true,"time":"16:30"}');
                        const className = document.getElementById('classSelector')?.value || '';

                        // Portal mode info
                        const portalSetup = selectedClass?.portalSetup || null;
                        const isPortalMode = portalSetup?.active === true;

                        // Today's schedule
                        const scheduleIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
                        let todaysClasses = [];
                        if (selectedClass?.subjects) {
                            selectedClass.subjects.forEach(sub => {
                                const classCount = sub.schedule?.[scheduleIndex] || 0;
                                if (classCount > 0) {
                                    todaysClasses.push({ name: sub.name, code: sub.code, periods: classCount });
                                }
                            });
                        }

                        // Check if today is a holiday
                        const isHoliday = selectedClass?.holidays?.includes(todayStr);
                        const loggedDays = Object.keys(attendanceLogs).length;
                        const todaysLog = attendanceLogs[todayStr];
                        const periodTimes = className ? JSON.parse(localStorage.getItem(`period_times_${className}`) || 'null') : null;

                        // Calculate total periods today
                        let totalTodayPeriods = 0;
                        todaysClasses.forEach(c => totalTodayPeriods += c.periods);

                        // Calculate overall attendance
                        let overallAttended = 0, overallTotal = 0;
                        currentAnalysisData?.forEach(a => {
                            overallAttended += a.attended || 0;
                            overallTotal += a.totalHeld || 0;
                        });
                        const overallPercent = overallTotal > 0 ? ((overallAttended / overallTotal) * 100).toFixed(1) : 0;

                        // Find subjects in danger (below minimum)
                        const minCriteria = parseFloat(document.getElementById('minAttendanceInput')?.value) || 75;
                        const subjectsInDanger = currentAnalysisData?.filter(a => {
                            const percent = a.totalHeld > 0 ? (a.attended / a.totalHeld) * 100 : 100;
                            return percent < minCriteria;
                        }).map(a => a.code) || [];

                        // Find subjects safe to skip
                        const subjectsSafeToSkip = currentAnalysisData?.filter(a => a.maxSkippable > 0)
                            .map(a => ({ code: a.code, canSkip: a.maxSkippable })) || [];

                        // Prepare comprehensive app context
                        const appContext = {
                            appName: "Bunk it - Smart Attendance Manager",
                            currentDate: todayStr,
                            currentDayName: currentDayName,
                            selectedClassName: className || 'None selected',
                            subjects: selectedClass?.subjects?.map(s => ({
                                name: s.name, code: s.code, schedule: s.schedule
                            })) || [],
                            currentAttendance: currentAnalysisData?.map(a => ({
                                code: a.code, name: a.name,
                                currentPercent: ((a.attended / a.totalHeld) * 100).toFixed(1),
                                attended: a.attended, totalHeld: a.totalHeld,
                                remaining: a.remaining, stillNeed: a.stillNeed, maxSkippable: a.maxSkippable
                            })) || [],
                            overallAttendance: { attended: overallAttended, total: overallTotal, percent: overallPercent },
                            subjectsInDanger: subjectsInDanger,
                            subjectsSafeToSkip: subjectsSafeToSkip,
                            minPercentage: minCriteria,
                            lastWorkingDate: selectedClass?.lastDate || 'Not set',
                            holidays: selectedClass?.holidays || [],
                            isHolidayToday: isHoliday,
                            portalMode: { active: isPortalMode, semesterStartDate: portalSetup?.semesterStartDate || null },
                            todaysClasses: isHoliday ? [] : todaysClasses,
                            totalTodayPeriods: isHoliday ? 0 : totalTodayPeriods,
                            periodTimes: periodTimes,
                            logs: { totalDays: loggedDays, todayLogged: !!todaysLog },
                            notifications: notificationSettings
                        };

                        // Comprehensive system prompt with ALL features
                        const systemPrompt = `You are "Bunkmate", the friendly AI assistant for "Bunk it - Smart Attendance Manager" app.

🔒 RULES:
1. Only answer questions about this app
2. Use provided data for personalized responses
3. LANGUAGE MATCHING: Match the user's language:
   - If user types in English → Reply in English
   - If user types in Hindi (हिंदी) → Reply in Hindi (हिंदी में जवाब दें)
   - If user types in Hinglish (mix of Hindi & English just like indian genz people type on whatsapp) → Reply in Hinglish (same style use karo)

📊 USER'S CURRENT DATA:
• Today: ${appContext.currentDate} (${appContext.currentDayName})
• Class: ${appContext.selectedClassName}
• Min Required: ${appContext.minPercentage}%
• Last Date: ${appContext.lastWorkingDate}
• Holiday Today: ${appContext.isHolidayToday ? 'YES!' : 'No'}
• Portal Mode: ${appContext.portalMode.active ? 'Active' : 'Inactive'}
• Today's Classes: ${appContext.isHolidayToday ? 'None (holiday)' : (appContext.todaysClasses.length > 0 ? JSON.stringify(appContext.todaysClasses) : 'None today')}
• Total Periods Today: ${appContext.totalTodayPeriods}
• Subjects: ${JSON.stringify(appContext.subjects.map(s => ({ name: s.name, code: s.code })))}
• Attendance: ${appContext.currentAttendance.length > 0 ? JSON.stringify(appContext.currentAttendance) : 'Not calculated yet'}
• Overall Attendance: ${appContext.overallAttendance.percent}% (${appContext.overallAttendance.attended}/${appContext.overallAttendance.total})
• Subjects in DANGER (below ${appContext.minPercentage}%): ${appContext.subjectsInDanger.length > 0 ? appContext.subjectsInDanger.join(', ') : 'None - all safe!'}
• Subjects SAFE to Skip: ${appContext.subjectsSafeToSkip.length > 0 ? JSON.stringify(appContext.subjectsSafeToSkip) : 'None - attend all!'}
• Total Holidays: ${appContext.holidays.length}
• Days Logged: ${appContext.logs.totalDays}
• Today Logged: ${appContext.logs.todayLogged ? 'Yes' : 'No'}
• Notifications: ${appContext.notifications.enabled ? 'On at ' + appContext.notifications.time : 'Off'}

📱 ALL APP FEATURES (explain when asked):

1️⃣ CLASS SETUP (4 methods):
• Form: Manual entry - Add Class → fill name, last date, subjects with schedules
• JSON: Paste JSON structure {"ClassName":{lastDate,holidays[],subjects[]}}
• AI Import: Upload timetable/attendance images → AI fills form automatically
• QR Scan: Scan classmate's QR to import their class setup

2️⃣ ATTENDANCE INPUT (3 methods):
• Image Upload: OCR extracts attendance from screenshots
• Manual Input: Enter total/attended per subject
• JSON Paste: {"CODE":{total,present}}

3️⃣ MODES:
• Portal Mode: Daily logging, ML recommendations, semester tracking (Settings → Portal Setup)
• Standard Mode: Quick one-time calculation without daily logs

4️⃣ LEAVE PLANNER:
• Add planned leave dates → see impact on attendance
• Compulsory events marking → warns about conflicts
• Medical Certificate recommendations → suggests optimal ML dates
• Max Safe Leave → shows days you can skip safely
• Long Weekend Finder → finds best leave strategy

5️⃣ TIMETABLE:
• Visual weekly schedule with drag-drop
• Period time configuration
• Current day highlighting with attendance status colors (green=safe, yellow=warning, red=danger)

6️⃣ NOTIFICATIONS:
• Daily reminders at custom time
• Only during semester period
• Enable in Settings → Notification Settings

7️⃣ ANALYSIS:
• Current %, Max possible %, Min possible %
• Still Need (must attend), Can Skip (safe to miss)
• Overall vs Per-Subject mode toggle

8️⃣ SETTINGS:
• Minimum attendance % (default 75%)
• Dark mode toggle
• API Settings for personal Gemini key
• Export/Backup class as JSON or QR

📊 MAX SAFE LEAVE FEATURE:
• Calculates exact dates you can skip entirely
• Considers your planned leaves + compulsory events
• Shows which subject is the bottleneck limiting safe leaves

🚫 MAX POSSIBLE BUNK (Avoid Detention):
• Calculates maximum skippable days at 65% DETENTION threshold (not 75%)
• Shows all dates you can bunk without getting detained
• MEDICAL CERTIFICATE SUGGESTIONS after bunking

🤔 CAN I SKIP TODAY? FEATURE:
• Quick check for today's impact
• Shows what happens if you skip all today's classes
• Per-subject impact analysis

👤 ABOUT THE DEVELOPER:
• Name: Faisal Khan
• Role: Solo Developer & Creator of Bunk it
• Buy Me a Coffee: https://buymeacoffee.com/Faisalkhan119
• The app is 100% free, ad-free, and open for donations

📝 RESPONSE FORMAT:
• Use numbered steps (1, 2, 3...) enter next line after every steps for how-to questions
• Use emojis for visual clarity
• Keep responses concise but helpful
• End with a helpful tip when relevant

🧠 SMART RESPONSES: When asked about skipping/leave, check their attendance data and give specific advice based on maxSkippable values and subject buffers.

Answer helpfully using this context.`;


                        try {
                            // Determine which keys to use
                            const keysToUse = [];
                            if (personalKey) {
                                // Priority 1: Personal Key (User entered in Settings)
                                keysToUse.push(...personalKey.split(',').map(k => k.trim()).filter(k => k));
                                console.log('🤖 Chatbot: Using Personal Key(s)');
                            } else if (window.SHARED_CHATBOT_KEY && window.SHARED_CHATBOT_KEY.length > 5) {
                                // Priority 2: Injected Shared Keys (From Build/Env)
                                keysToUse.push(...window.SHARED_CHATBOT_KEY.split(',').map(k => k.trim()).filter(k => k));
                                console.log('🤖 Chatbot: Using Injected Shared Keys');
                            } else {
                                // Priority 3: Fallback Shared Keys (Obfuscated)
                                // Use centralized helper
                                keysToUse.push(...getFallbackSharedKeys());
                                console.log('🤖 Chatbot: Using Fallback Shared Keys');
                            }

                            if (keysToUse.length > 0) {
                                // === DIRECT API CALL WITH ROTATION ===
                                let lastError = null;

                                for (let i = 0; i < keysToUse.length; i++) {
                                    const currentKey = keysToUse[i];
                                    try {
                                        console.log(`🤖 Chatbot: Attempting key ${i + 1}/${keysToUse.length}`);

                                        response = await fetch(
                                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${currentKey}`,
                                            {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                    contents: [{
                                                        parts: [
                                                            { text: systemPrompt },
                                                            { text: `User question: ${userQuestion}` }
                                                        ]
                                                    }]
                                                })
                                            }
                                        );

                                        if (response.ok) {
                                            console.log('🤖 Chatbot: Success!');
                                            const result = await response.json();
                                            return result.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I could not generate a response.';
                                        }

                                        // If Quota Exceeded (429), try next key
                                        if (response.status === 429) {
                                            console.warn(`🤖 Chatbot: Key ${i + 1} exhausted (429). Rotating...`);
                                            lastError = `Quota exceeded for key ${i + 1}`;
                                            continue;
                                        }

                                        // Other errors - throw immediately
                                        const errorData = await response.json().catch(() => ({}));
                                        throw new Error(`API Error ${response.status}: ${errorData.error?.message || 'Unknown'}`);

                                    } catch (err) {
                                        console.error(`🤖 Chatbot: Key ${i + 1} failed:`, err);
                                        lastError = err.message;
                                        // If last key, don't continue loop effectively, just fall through
                                    }
                                }

                                // If we get here, all keys failed
                                throw new Error(`All API keys failed. Last error: ${lastError}`);

                            } else {
                                // === FALLBACK: BACKEND PROXY ===
                                // Priority 3: Vercel Proxy (if no keys found in frontend)
                                console.log('🤖 Chatbot: Using backend proxy');
                                response = await fetch('/api/gemini', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        action: 'chat',
                                        systemPrompt: systemPrompt,
                                        prompt: `User question: ${userQuestion}`
                                    })
                                });

                                if (!response.ok) {
                                    const errorData = await response.json().catch(() => ({}));
                                    throw new Error(`Proxy Error ${response.status}: ${errorData.error || 'Unknown'}`);
                                }

                                const result = await response.json();
                                return result.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I could not generate a response.';
                            }

                        } catch (error) {
                            console.error('Gemini API error:', error);
                            return `❌ Connection Error: ${error.message}\n\nCheck your internet connection and try again.`;
                        }
                    }



                    // API Settings function (renamed from openOCRSettings)
                    // Test API key
                    async function testAPIKey() {
                        const key = document.getElementById('personalGeminiKey').value.trim();

                        if (!key) {
                            showToast('Please enter an API key first.', 'warning');
                            return;
                        }

                        try {
                            const response = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        contents: [{ parts: [{ text: 'Test' }] }]
                                    })
                                }
                            );

                            if (response.ok) {
                                showToast('API key is valid and working!', 'success');
                            } else if (response.status === 400) {
                                showToast('Invalid API key. Please check and try again.', 'error');
                            } else if (response.status === 429) {
                                showToast('API key is valid but quota exceeded.', 'warning');
                            } else {
                                showToast(`Error ${response.status}. Please try again.`, 'error');
                            }
                        } catch (error) {
                            showToast('Connection error. Please check your internet connection.', 'error');
                        }
                    }



                    // API Settings function (renamed from openOCRSettings)
                    function openAPISettings() {
                        const modal = document.getElementById('ocrSettingsModal');

                        // Populate the modal content
                        modal.innerHTML = `
                    <div class="modal-content">
                        <button class="modal-close" onclick="closeModal('ocrSettingsModal')">&times;</button>
                        <div class="modal-header">
                            <h2>🔑 API Settings</h2>
                            <p>Configure your Gemini API key for OCR and AI Assistant features</p>
                        </div>
                        <div class="form-group">
                            <label for="personalGeminiKey">Personal Gemini API Key:</label>
                            <input type="text" id="personalGeminiKey" placeholder="AIzaSy...">
                            <p style="font-size: 0.85rem; color: var(--medium-text); margin-top: 8px;">
                                💡 Your API key enables OCR scanning and AI chatbot features.
                            </p>
                        </div>

                        <div
                            style="background: var(--light-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; font-size: 1rem;">🔑 How to Get Free API Key:</h4>
                            <ol style="margin: 0; padding-left: 20px; color: var(--dark-text);">
                                <li>Visit <a href="https://aistudio.google.com/app/apikey" target="_blank"
                                        rel="noopener noreferrer" style="color: var(--primary-grad-start);">Google AI
                                        Studio</a></li>
                                <li>Click <strong>"Get API Key"</strong> or <strong>"Create API Key"</strong></li>
                                <li>Copy the key (starts with <code>AIzaSy...</code>)</li>
                                <li>Paste it above and click <strong>Save</strong></li>
                            </ol>
                        </div>

                        <div class="form-actions">
                            <button class="btn primary-btn" onclick="saveAPISettings()">💾 Save Settings</button>
                            <button class="btn secondary-btn" onclick="testAPIKey()">🧪 Test My Key</button>
                        </div>
                    </div>
                    `;

                        // Load saved settings
                        const personalKey = localStorage.getItem('personalGeminiKey') || '';
                        setTimeout(() => {
                            const personalKeyInput = document.getElementById('personalGeminiKey');
                            if (personalKeyInput) {
                                personalKeyInput.value = personalKey;
                            }
                        }, 10);

                        openModal('ocrSettingsModal');
                    }

                    // Save API Settings
                    function saveAPISettings() {
                        const keyInput = document.getElementById('personalGeminiKey');
                        const personalKey = keyInput ? keyInput.value.trim() : '';

                        if (personalKey) {
                            localStorage.setItem('personalGeminiKey', personalKey);
                            showToast('API key saved successfully!', 'success');
                        } else {
                            localStorage.removeItem('personalGeminiKey');
                            showToast('API key cleared.', 'info');
                        }

                        // Toggle chatbot button visibility
                        if (typeof toggleChatbotVisibility === 'function') {
                            toggleChatbotVisibility();
                        }

                        // Toggle chatbot button visibility
                        if (typeof toggleChatbotVisibility === 'function') {
                            toggleChatbotVisibility();
                        }
                        closeModal('ocrSettingsModal');
                    }

                </script>

                <style>
                    /* AI Chat Panel Active State */
                    #aiChatPanel.active {
                        right: 0;
                    }

                    /* Chat Message Styles */
                    .chat-message {
                        padding: 12px;
                        border-radius: 12px;
                        font-size: 0.9rem;
                        max-width: 85%;
                        word-wrap: break-word;
                    }

                    .chat-message.user {
                        background: linear-gradient(135deg, var(--primary-grad-start), var(--primary-grad-end));
                        color: white;
                        margin-left: auto;
                        border-bottom-right-radius: 4px;
                    }

                    .chat-message.bot {
                        background: var(--card-bg);
                        color: var(--dark-text);
                        border: 1px solid var(--border-color);
                        border-bottom-left-radius: 4px;
                    }

                    .chat-message.system {
                        background: var(--light-bg);
                        color: var(--medium-text);
                        font-style: italic;
                        font-size: 0.85rem;
                        text-align: center;
                        margin: 0 auto;
                    }

                    /* Dark Mode Specific Overrides */
                    .dark-mode #aiChatbotButton {
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
                    }

                    .dark-mode #aiChatPanel {
                        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.8);
                    }

                    /* Light Mode FAQ Button Styles */
                    #aiChatPanel .faq-btn,
                    #aiChatPanel .btn {
                        background: var(--light-bg);
                        color: var(--dark-text);
                        border: 1px solid var(--border-color);
                        transition: background 0.2s ease;
                    }

                    #aiChatPanel .faq-btn:hover,
                    #aiChatPanel .btn:hover {
                        background: rgba(0, 0, 0, 0.05);
                    }

                    /* Dark Mode FAQ Button - Greyish black with white text */
                    body.dark-mode #aiChatPanel .faq-btn,
                    .dark-mode #aiChatPanel .faq-btn,
                    body.dark-mode #aiChatPanel .btn,
                    .dark-mode #aiChatPanel .btn {
                        background: #2a2a2a !important;
                        color: #ffffff !important;
                        border: 1px solid #404040 !important;
                    }

                    body.dark-mode #aiChatPanel .faq-btn:hover,
                    .dark-mode #aiChatPanel .faq-btn:hover,
                    body.dark-mode #aiChatPanel .btn:hover,
                    .dark-mode #aiChatPanel .btn:hover {
                        background: #353535 !important;
                        color: #ffffff !important;
                    }

                    /* Responsive Design */
                    @media (max-width: 768px) {
                        #aiChatPanel {
                            width: 100%;
                            right: -100%;
                        }

                        /* AI button uses same position on all devices */
                    }

                    /* Scrollbar Styling for Chat */
                    #chatMessages::-webkit-scrollbar {
                        width: 6px;
                    }

                    #chatMessages::-webkit-scrollbar-track {
                        background: var(--light-bg);
                    }

                    #chatMessages::-webkit-scrollbar-thumb {
                        background: var(--border-color);
                        border-radius: 3px;
                    }

                    #chatMessages::-webkit-scrollbar-thumb:hover {
                        background: var(--medium-text);
                    }

                    /* Toast Notifications */
                    #toast-container {
                        position: fixed;
                        bottom: 30px;
                        left: 50%;
                        transform: translateX(-50%);
                        z-index: 9999;
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                        pointer-events: none;
                        width: max-content;
                        max-width: 90%;
                    }

                    .toast {
                        background: var(--card-bg);
                        color: var(--dark-text);
                        padding: 12px 24px;
                        border-radius: 50px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
                        border: 1px solid var(--border-color);
                        font-family: 'Outfit', sans-serif;
                        font-weight: 500;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        opacity: 1;
                        pointer-events: auto;
                        animation: toastIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                        -webkit-backdrop-filter: blur(12px);
                        backdrop-filter: blur(12px);
                    }

                    .toast.hide {
                        animation: toastOut 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
                    }

                    @keyframes toastIn {
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }

                    @keyframes toastOut {
                        to {
                            opacity: 0;
                            transform: translateY(20px) scale(0.9);
                        }
                    }

                    .toast.success {
                        border-left: 4px solid var(--success-grad-start);
                    }

                    .toast.error {
                        border-left: 4px solid var(--danger-color);
                    }

                    .toast.warning {
                        border-left: 4px solid var(--warning-color);
                    }

                    /* View Transitions (Animation on Display) */
                    @keyframes fadeInSlideUp {
                        from {
                            opacity: 0;
                            transform: translateY(15px) scale(0.98);
                        }

                        to {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }

                    /* AI Chat Panel Active State */
                    #aiChatPanel.active {
                        right: 0 !important;
                    }

                    #resultsSection,
                    #portalDashboardSection,
                    #uploadSection,
                    #manualInput,
                    #jsonInput,
                    #leavePlannerSection,
                    #analysisResults,
                    #tabularAnalysisSection,
                    #graphAnalysisSection,
                    .section-view {
                        animation: fadeInSlideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
                    }

                    .fade-out {
                        opacity: 0 !important;
                    }

                    .fade-in {
                        opacity: 1 !important;
                    }

                    @keyframes glowingPulse {
                        0% {
                            box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
                        }

                        70% {
                            box-shadow: 0 0 0 15px rgba(102, 126, 234, 0);
                        }

                        100% {
                            box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
                        }
                    }

                    .glowing-pulse {
                        animation: glowingPulse 2s infinite !important;
                    }
                </style>
                <script>
                    // Global Haptic Feedback for all buttons
                    document.addEventListener('click', function (e) {
                        const target = e.target.closest('button, .btn, .fixed-ui-button, select, input[type="checkbox"], input[type="radio"]');
                        if (target && navigator.vibrate) {
                            navigator.vibrate(15);
                        }
                    });

                    // Toast Notification Helper
                    window.showToast = function (message, type = 'info') {
                        let container = document.getElementById('toast-container');
                        if (!container) {
                            container = document.createElement('div');
                            container.id = 'toast-container';
                            document.body.appendChild(container);
                        }

                        const toast = document.createElement('div');
                        toast.className = `toast ${type}`;

                        let icon = 'ℹ️';
                        if (type === 'success') icon = '✅';
                        if (type === 'error') icon = '❌';
                        if (type === 'warning') icon = '⚠️';

                        toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;

                        container.appendChild(toast);

                        if (navigator.vibrate) navigator.vibrate(20);

                        setTimeout(() => {
                            toast.classList.add('hide');
                            toast.addEventListener('animationend', () => {
                                if (toast.parentElement) toast.remove();
                            });
                        }, 3000);
                    };

                    // Initialize Slider - Duplicate content for seamless scrolling
                    // Initialize Slider - Duplicate content for seamless scrolling
                    window.addEventListener('DOMContentLoaded', () => {
                        const track = document.querySelector('.slider-track');
                        if (track) {
                            // Clone items to ensure seamless loop
                            if (track.children.length > 0) {
                                track.innerHTML += track.innerHTML;
                            }
                            // Force styles via JS to ensure visibility
                            track.style.display = 'flex';
                            track.style.width = 'max-content';
                        }

                        // DEBUG & FIX CHATBOT
                        setTimeout(() => {
                            const buttons = Array.from(document.querySelectorAll('button'));
                            const sendBtn = buttons.find(b => b.innerText.trim() === 'Send' || b.textContent.trim() === 'Send');

                            if (sendBtn) {
                                // Override click handler
                                sendBtn.onclick = function (e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    if (window.sendChatMessage) window.sendChatMessage();
                                    else alert("Global sendChatMessage not found!");
                                };
                            }
                        }, 1000); // Delay to ensure DOM is fully ready
                    });
                </script>
                <script>
                    // --- PWA INSTALL PROMPT LOGIC ---
                    function setupPwaInstall() {
                        // Add HTML Container
                        const pwaContainer = document.createElement('div');
                        pwaContainer.id = 'pwaInstallSheet';
                        pwaContainer.className = 'pwa-install-sheet';
                        pwaContainer.innerHTML = `
            <div class="pwa-content">
                <div class="pwa-icon" style="background: none;">
                    <img src="icon-192x192.png" alt="Bunkit" style="width: 100%; height: 100%; border-radius: 12px;">
                </div>
                <div class="pwa-details">
                    <h3 id="pwaTitle">Install Bunkit</h3>
                    <p id="pwaDesc">Add to home screen for the best experience.</p>
                </div>
            </div>
            <div id="iosInstruction" class="ios-instruction" style="display: none;">
                <span>Tap <i class="fas fa-share-square"></i> then "Add to Home Screen" <i class="far fa-plus-square"></i></span>
            </div>
            <div class="pwa-actions">
                <button class="pwa-btn secondary" onclick="dismissPwaPrompt()">Not Now</button>
                <button id="pwaInstallBtn" class="pwa-btn primary">Install App</button>
            </div>
        `;
                        document.body.appendChild(pwaContainer);

                        let deferredPrompt;
                        const sheet = document.getElementById('pwaInstallSheet');
                        const installBtn = document.getElementById('pwaInstallBtn');
                        const iosInstruction = document.getElementById('iosInstruction');
                        const pwaTitle = document.getElementById('pwaTitle');
                        const pwaDesc = document.getElementById('pwaDesc');

                        // Check if dismissed recently (e.g., within 7 days)
                        const dismissedTime = localStorage.getItem('pwaPromptDismissed');
                        if (dismissedTime) {
                            const daysSince = (new Date() - new Date(dismissedTime)) / (1000 * 60 * 60 * 24);
                            if (daysSince < 7) return;
                        }

                        // ANDROID / DESKTOP (Native Prompt)
                        window.addEventListener('beforeinstallprompt', (e) => {
                            e.preventDefault();
                            deferredPrompt = e;

                            // Show custom sheet
                            sheet.classList.add('active');

                            installBtn.onclick = async () => {
                                sheet.classList.remove('active');
                                if (deferredPrompt) {
                                    deferredPrompt.prompt();
                                    const { outcome } = await deferredPrompt.userChoice;
                                    console.log(`User response to install prompt: ${outcome}`);
                                    deferredPrompt = null;
                                }
                            };
                        });

                        // iOS DETECTION
                        const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
                        const isStandalone = ('standalone' in navigator) && navigator.standalone;

                        if (isIOS && !isStandalone) {
                            // Customize for iOS
                            pwaTitle.textContent = "Install on iOS";
                            pwaDesc.textContent = "Install Bunkit for offline access.";
                            iosInstruction.style.display = 'flex';
                            installBtn.style.display = 'none'; // IOS doesn't support programmatic install

                            // Show sheet (maybe with a slight delay)
                            setTimeout(() => {
                                sheet.classList.add('active');
                            }, 3000);
                        }
                    }

                    function dismissPwaPrompt() {
                        const sheet = document.getElementById('pwaInstallSheet');
                        if (sheet) sheet.classList.remove('active');
                        localStorage.setItem('pwaPromptDismissed', new Date().toISOString());
                    }

                    // Initialize PWA logic
                    window.addEventListener('load', setupPwaInstall);

                    // VALIDATION FOR SETTINGS
                    function validateMedicalSettings() {
                        const minInput = document.getElementById('minAttendanceInput');
                        const medInput = document.getElementById('minMedicalInput');
                        const btnMaxBunk = document.getElementById('btnMaxBunk');

                        if (!minInput || !medInput) return;

                        const minVal = parseFloat(minInput.value) || 75;
                        let medVal = parseFloat(medInput.value) || 0;

                        // Constraint: Medical Min must be <= Minimum Attendance
                        if (medVal > minVal) {
                            // Clamp to Max
                            medInput.value = minVal;
                            medVal = minVal;

                            // Feedback
                            const msg = `Medical Policy: Medical criteria cannot exceed standard attendance (${minVal}%). Adjusted to ${minVal}%.`;
                            if (typeof showToast === 'function') {
                                showToast('⚠️ ' + msg, 'warning');
                            } else {
                                alert(msg);
                            }
                        }

                        // Update UI constraints
                        medInput.setAttribute('max', minVal);

                        // Toggle Max Bunk Button Visibility
                        // If Medical == Min, there is no gap for "Bunk", so hide the button
                        // We use a small epsilon for float comparison just in case
                        if (btnMaxBunk) {
                            if (Math.abs(medVal - minVal) < 0.1) {
                                btnMaxBunk.style.display = 'none';
                            } else {
                                btnMaxBunk.style.display = 'block';
                                btnMaxBunk.style.marginLeft = 'auto'; // Re-apply inline styles if needed
                                btnMaxBunk.style.marginRight = 'auto';
                            }
                        }
                    }
                    // Run once on load to ensure consistency
                    window.addEventListener('load', validateMedicalSettings);
                </script>

                <script>
                    // --- SYNC HOOKS (Runtime Overrides) ---
                    // Hook Class Deletion to trigger Cloud Delete
                    // We do this by wrapping the global function because we couldn't easily locate it in the source
                    window.addEventListener('load', function () {
                        const originalDeleteSelectedClass = window.deleteSelectedClass;

                        if (typeof originalDeleteSelectedClass === 'function') {
                            window.deleteSelectedClass = function () {
                                // Capture class name BEFORE deletion attempt
                                const classToDelete = selectedClass && selectedClass.name ? selectedClass.name : null;

                                // CONFIRMATION handled by originalDeleteSelectedClass
                                // We just hook to detect if deletion occurred

                                // Call original function (handles confirmation prompts etc.)
                                originalDeleteSelectedClass();

                                // Check if deletion actually happened
                                if (classToDelete && !classes[classToDelete]) {
                                    console.log(`[Sync] Detected deletion of class "${classToDelete}". Syncing deletion to cloud...`);
                                    if (window.SyncManager) {
                                        SyncManager.deleteClass(classToDelete);
                                    }
                                }
                            };
                            console.log('✅ deleteSelectedClass hooked for Cloud Sync');
                        } else {
                            console.warn('⚠️ deleteSelectedClass function not found! Cloud deletion will not work automatically.');
                        }
                    });
                </script>

                <!-- LOGIN SCREEN & ONBOARDING -->
                <style>
                    #loginScreen {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(15, 23, 42, 0.95);
                        backdrop-filter: blur(10px);
                        z-index: 99999;
                        display: none;
                        /* Flex Layout for safe scrolling */
                        display: flex;
                        align-items: flex-start;
                        /* Start from top to allow scrolling */
                        justify-content: center;
                        overflow-y: auto;
                        /* Enable vertical scroll */
                        padding: 30px 20px;
                        /* Vertical padding prevents clipping */
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }

                    /* Ensure full height content can scroll properly using pseudo-element or safe flex properties */
                    #loginScreen:before {
                        content: '';
                        display: block;
                        height: 100%;
                        width: 0;
                    }

                    #loginScreen.active {
                        opacity: 1;
                    }

                    .login-card {
                        background: rgba(30, 41, 59, 0.8);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 24px;
                        padding: 40px;
                        width: 90%;
                        /* Responsive width */
                        max-width: 500px;
                        /* WIDER as requested */
                        text-align: center;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                        margin: auto;
                        /* Vertically centers if height allows, else scrolls */
                        flex-shrink: 0;
                    }

                    .login-header h1 {
                        font-size: 2.5rem;
                        margin-bottom: 5px;
                        background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
                        -webkit-background-clip: text;
                        background-clip: text;
                        background-clip: text;
                        -webkit-text-fill-color: transparent;
                        font-weight: 800;
                    }

                    .login-header p {
                        color: #94a3b8;
                        margin-bottom: 30px;
                    }

                    .login-btn {
                        width: 100%;
                        padding: 12px;
                        border-radius: 12px;
                        border: none;
                        font-weight: 600;
                        font-size: 1rem;
                        cursor: pointer;
                        transition: transform 0.2s, box-shadow 0.2s;
                        margin-bottom: 15px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                    }

                    .login-btn:active {
                        transform: scale(0.98);
                    }

                    .google-btn {
                        background: white;
                        color: #1e293b;
                    }

                    .guest-btn {
                        background: transparent;
                        color: #94a3b8;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        margin-top: 10px;
                    }

                    .guest-btn:hover {
                        background: rgba(255, 255, 255, 0.05);
                        color: white;
                    }

                    .divider {
                        display: flex;
                        align-items: center;
                        margin: 20px 0;
                        color: #64748b;
                        font-size: 0.8rem;
                    }

                    .divider::before,
                    .divider::after {
                        content: "";
                        flex: 1;
                        height: 1px;
                        background: rgba(255, 255, 255, 0.1);
                    }

                    .divider span {
                        padding: 0 10px;
                    }

                    .auth-input {
                        width: 100%;
                        padding: 12px 15px;
                        background: rgba(0, 0, 0, 0.2);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 12px;
                        color: white;
                        margin-bottom: 10px;
                        outline: none;
                        transition: border-color 0.2s;
                    }

                    .auth-input:focus {
                        border-color: #60a5fa;
                    }

                    .primary-auth-btn {
                        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
                        color: white;
                    }

                    .toggle-auth-mode {
                        margin-top: 15px;
                        color: #94a3b8;
                        font-size: 0.9rem;
                        cursor: pointer;
                    }

                    .toggle-auth-mode:hover {
                        color: #60a5fa;
                        text-decoration: underline;
                    }
                </style>

                <!-- DEAD GHOST CODE - COMMENTED OUT
                <div id="loginScreen">
                   ... (Old Login UI) ...
                </div>
                -->

                <script>
                    // --- AUTH UI LOGIC ---
                    let isSignup = false;


                    // Password visibility toggle function
                    function togglePasswordVisibility(inputId, iconSpan) {
                        const inputEl = document.getElementById(inputId);
                        const icon = iconSpan.querySelector('i');

                        if (inputEl.type === 'password') {
                            inputEl.type = 'text';
                            icon.classList.remove('fa-eye');
                            icon.classList.add('fa-eye-slash');
                        } else {
                            inputEl.type = 'password';
                            icon.classList.remove('fa-eye-slash');
                            icon.classList.add('fa-eye');
                        }
                    }

                    function toggleAuthMode() {
                        isSignup = !isSignup;
                        const nameInput = document.getElementById('signupName');
                        const confirmPasswordWrapper = document.getElementById('confirmPasswordWrapper');
                        const btn = document.getElementById('emailAuthBtn');
                        const toggle = document.getElementById('authModeToggle');

                        if (isSignup) {
                            nameInput.style.display = 'block';
                            confirmPasswordWrapper.style.display = 'block';
                            btn.textContent = 'Create Account';
                            toggle.textContent = 'Already have an account? Sign In';

                            // Check if there is local data to import
                            const hasLocalData = localStorage.getItem('attendanceClasses_v2') && localStorage.getItem('attendanceClasses_v2') !== '{}';
                            const dataOption = document.getElementById('signupDataOption');
                            const importCheckbox = document.getElementById('importLocalData');

                            if (hasLocalData && dataOption) {
                                dataOption.style.display = 'block';
                                // Auto-check if currently in Guest Mode (Explicit intent)
                                const isGuest = localStorage.getItem('guest_mode_active');
                                importCheckbox.checked = !!isGuest;
                            } else if (dataOption) {
                                dataOption.style.display = 'none';
                            }

                        } else {
                            nameInput.style.display = 'none';
                            confirmPasswordWrapper.style.display = 'none';
                            btn.textContent = 'Sign In';
                            toggle.textContent = 'New here? Create an account';

                            // Hide data option in Sign In mode
                            const dataOption = document.getElementById('signupDataOption');
                            if (dataOption) dataOption.style.display = 'none';
                        }
                    }

                    async function handleEmailSubmit() {
                        const email = document.getElementById('loginEmail').value;
                        const password = document.getElementById('loginPassword').value;
                        const name = document.getElementById('signupName').value;
                        const btn = document.getElementById('emailAuthBtn');

                        if (!email || !password) {
                            alert('Please enter email and password');
                            return;
                        }

                        btn.disabled = true;
                        btn.textContent = 'Processing...';

                        try {
                            if (isSignup) {
                                if (!name) { alert('Please enter your name'); btn.disabled = false; btn.textContent = 'Create Account'; return; }

                                // SIGNAL: Mark this as a new signup to preserve Guest Data during Sync
                                // ONLY if user explicitly checked the box
                                const keepData = document.getElementById('importLocalData').checked;
                                if (keepData) {
                                    localStorage.setItem('is_new_signup', 'true');
                                } else {
                                    localStorage.removeItem('is_new_signup'); // Ensure wipe
                                }

                                // Validate password confirmation
                                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                                if (password !== confirmPassword) {
                                    alert('Passwords do not match!');
                                    btn.disabled = false;
                                    btn.textContent = 'Create Account';
                                    return;
                                }

                                const { error } = await AuthManager.signUp(email, password, name);
                                if (error) throw error;
                                alert('Signup successful! Please enter the 6-digit verification code from your email.');
                                if (window.openVerifyEmailModal) window.openVerifyEmailModal(email);
                            } else {
                                const { error } = await AuthManager.signIn(email, password);
                                if (error) throw error;

                                // Success! The AuthManager.onAuthStateChange listener will handle the UI update and Sync.
                                // Do NOT reload, as it causes race conditions with session persistence and sync.
                                btn.textContent = 'Success!';
                            }
                        } catch (e) {
                            alert(e.message);
                        } finally {
                            btn.disabled = false;
                            btn.textContent = isSignup ? 'Create Account' : 'Sign In';
                        }
                    }

                    // --- ONBOARDING AUTOMATION ---
                    window.activeUserCheck = null;

                    function triggerOnboardingCheck(user) {
                        // ╔════════════════════════════════════════════════════════════╗
                        // ║ SAFETY LOCK: Only allow if user came via IMPORT LINK       ║
                        // ║ Otherwise: NO automatic popups.                             ║
                        // ╚════════════════════════════════════════════════════════════╝

                        const pendingImport = sessionStorage.getItem('pendingClassImport');
                        const profileName = localStorage.getItem('userProfileName');

                        // EXCEPTION: If user came via link AND doesn't have name, show name prompt
                        if (pendingImport && !profileName) {
                            console.log('📥 Link import detected + No name. Showing name prompt...');
                            if (typeof createProfileModals === 'function') createProfileModals();
                            setTimeout(() => {
                                if (document.getElementById('firstLoginPromptModal')) {
                                    openModal('firstLoginPromptModal');
                                    // Pre-fill name if available from Google
                                    if (user?.user_metadata?.full_name) {
                                        const input = document.getElementById('firstLoginNameInput');
                                        if (input) input.value = user.user_metadata.full_name;
                                    }
                                }
                            }, 500);
                            return;
                        }

                        // If user came via link AND has name, import directly
                        if (pendingImport && profileName) {
                            console.log('📥 Link import detected + Name exists. Importing directly...');
                            setTimeout(() => importClassFromURL(pendingImport), 500);
                            return;
                        }

                        // If key exists but no import link, proceed to Standard Onboarding
                        if (typeof checkFirstLoginPrompt === 'function') {
                            checkFirstLoginPrompt();
                        } else {
                            console.log('🚫 checkFirstLoginPrompt not found, skipping onboarding.');
                        }
                    }

                    // Hook into AuthManager to trigger onboarding
                    // We use a polling check for the user state change or rely on the fact that AuthManager calls updateUser
                    // Hook into AuthManager to trigger onboarding safely
                    if (window.AuthManager) {
                        const originalUpdateUser = AuthManager.updateUser;
                        AuthManager.updateUser = function (user) {
                            originalUpdateUser.call(this, user);
                            // Only trigger if we are now logged in (or guest mode confirmed)
                            if (document.body.classList.contains('logged-in') || document.body.classList.contains('guest-mode')) {
                                triggerOnboardingCheck(user);
                            }
                        };
                    } else {
                        // Fallback: Listen for auth-initialized event (defined in AuthManager.init)
                        window.addEventListener('auth-initialized', (e) => {
                            if (document.body.classList.contains('logged-in') || document.body.classList.contains('guest-mode')) {
                                triggerOnboardingCheck(e.detail.user);
                            }
                        });
                    }

                    // Also fix the toggleLoginScreen to actually work with our new ID and layout
                    if (window.AuthManager) {
                        window.AuthManager.toggleLoginScreen = function (show) {
                            // GUARD: Block hiding the login screen if pending reset
                            if (!show) {
                                if (localStorage.getItem('pending_password_reset') === 'true' || window.isVerifyingOtp) {
                                    console.log('🔒 AuthManager.toggleLoginScreen (Inline) blocked (Hide Mode) due to pending reset.');
                                    const screen = document.getElementById('loginScreen');
                                    if (screen) screen.style.display = 'none';
                                    return;
                                }
                            }

                            const screen = document.getElementById('loginScreen');
                            if (screen) {
                                if (show) {
                                    screen.style.display = 'flex';
                                    setTimeout(() => screen.classList.add('active'), 10);
                                } else {
                                    screen.classList.remove('active');
                                    setTimeout(() => screen.style.display = 'none', 300);
                                }
                            }
                        };
                    } else {
                        console.warn('AuthManager not found during toggleLoginScreen patch');
                    }

                    // Initial check on load (in case AuthManager ran before this script)
                    if (window.AuthManager && !window.AuthManager.user && !localStorage.getItem('guest_mode_active')) {
                        // Force show login if no session and no guest mode
                        // But wait for initial auth check to complete? 
                        // AuthManager.init() does this check.
                    }
                </script>
                <script>
                    // --- SOCIAL FEATURES HOOK (Monkey Patch) ---
                    (function () {
                        const initHook = setInterval(() => {
                            // Wait for dependencies to load
                            if (window.SocialManager && typeof window.triggerRecalculation === 'function') {
                                clearInterval(initHook);
                                console.log("⚓ Hooking Social Features...");

                                // Hook into the main calculation trigger
                                const originalRecalc = window.triggerRecalculation;
                                window.triggerRecalculation = async function () {
                                    // 1. Run original logic first
                                    originalRecalc.apply(this, arguments);

                                    // 2. Run Social Logic
                                    if (window.selectedClass && window.classes && window.classes[window.selectedClass]) {
                                        const cls = window.classes[window.selectedClass];
                                        const oldId = cls.sharedId; // Store old ID before check

                                        try {
                                            // A. Auto-Generate Shared Class ID
                                            const newId = await SocialManager.generateSharedClassId(cls);

                                            // PROPOSAL CHECK: If ID Changed AND Old ID existed AND Not a new/empty class
                                            if (oldId && newId && oldId !== newId) {
                                                console.log(`🆔 Version Change: ${oldId} -> ${newId}`);

                                                // Trigger Proposal Flow (only if editing, not during initial load)
                                                if (window._isEditingClass) {
                                                    SocialManager.proposeUpdate(oldId, newId, cls, { msg: "Critical Class Details Changed" });
                                                    window._isEditingClass = false; // Reset
                                                }
                                            }

                                            if (newId && newId !== cls.sharedId) {
                                                console.log(`🆔 Shared ID Updated: ${newId}`);
                                                cls.sharedId = newId;
                                                if (window.saveToStorage) window.saveToStorage();

                                                // Sync to cloud if online
                                                if (window.SyncManager) SyncManager.saveClass(window.selectedClass, cls);
                                            }

                                            // B. Update Mass Bunk Status (Daily)
                                            if (cls.sharedId) {
                                                SocialManager.updateDailyStatus(cls);

                                                // C. Check for Incoming Updates (Receiver)
                                                SocialManager.checkForClassUpdates(cls.sharedId, cls);
                                            }
                                        } catch (err) {
                                            console.error("Social Hook Error:", err);
                                        }
                                    }
                                };

                                // Hook saveClass to set the "Editing" flag
                                if (typeof window.saveClass === 'function') {
                                    const originalSave = window.saveClass;
                                    window.saveClass = function () {
                                        window._isEditingClass = true; // Set flag
                                        try {
                                            return originalSave.apply(this, arguments);
                                        } finally {
                                            // Safety Reset after 2s in case triggerRecalculation doesn't fire/reset
                                            setTimeout(() => { window._isEditingClass = false; }, 2000);
                                        }
                                    }
                                }
                            }
                        }, 500); // Check every 500ms
                    })();
                </script>

                <!-- Reset Password Modal (New Password Entry - After Email Link Click) -->
                <div class="rp-modal-overlay" id="resetPasswordModal">
                    <div class="rp-modal">
                        <div class="rp-modal-header">
                            <i class="fa-solid fa-lock-open"></i>
                            <h3>Set New Password</h3>
                            <p>Enter your new password below</p>
                        </div>
                        <div class="rp-modal-body">
                            <div class="rp-password-wrapper">
                                <input type="password" id="rpNewPassword" placeholder="New Password">
                                <span class="rp-password-toggle" onclick="toggleRpPassword('rpNewPassword', this)">
                                    <i class="fa-regular fa-eye"></i>
                                </span>
                            </div>
                            <div class="rp-password-wrapper">
                                <input type="password" id="rpConfirmPassword" placeholder="Confirm New Password">
                                <span class="rp-password-toggle" onclick="toggleRpPassword('rpConfirmPassword', this)">
                                    <i class="fa-regular fa-eye"></i>
                                </span>
                            </div>
                            <div class="rp-requirements">
                                ℹ️ Password must be at least 6 characters long
                            </div>
                            <div class="rp-status" id="rpStatus"></div>
                        </div>
                        <div class="rp-modal-buttons">
                            <button class="rp-btn rp-btn-cancel" onclick="closeResetPasswordModal()">Cancel</button>
                            <button class="rp-btn rp-btn-primary" id="rpSubmitBtn" onclick="submitNewPassword()">
                                <i class="fa-solid fa-check"></i> Update Password
                            </button>
                        </div>
                    </div>
                </div>

                <script>
                    // --- RESET PASSWORD (NEW PASSWORD ENTRY) FUNCTIONS ---
                    window.toggleRpPassword = function (inputId, iconSpan) {
                        const inputEl = document.getElementById(inputId);
                        const icon = iconSpan.querySelector('i');
                        if (inputEl.type === 'password') {
                            inputEl.type = 'text';
                            icon.classList.remove('fa-eye');
                            icon.classList.add('fa-eye-slash');
                        } else {
                            inputEl.type = 'password';
                            icon.classList.remove('fa-eye-slash');
                            icon.classList.add('fa-eye');
                        }
                    };

                    window.showResetPasswordModal = function () {
                        const modal = document.getElementById('resetPasswordModal');
                        if (modal) {
                            modal.classList.add('rp-visible');
                            setTimeout(() => {
                                const input = document.getElementById('rpNewPassword');
                                if (input) input.focus();
                            }, 300);
                        }
                    };

                    window.closeResetPasswordModal = function () {
                        const modal = document.getElementById('resetPasswordModal');
                        if (modal) {
                            modal.classList.remove('rp-visible');
                            // Clear inputs
                            const newPwd = document.getElementById('rpNewPassword');
                            const confirmPwd = document.getElementById('rpConfirmPassword');
                            const status = document.getElementById('rpStatus');
                            if (newPwd) newPwd.value = '';
                            if (confirmPwd) confirmPwd.value = '';
                            if (status) {
                                status.className = 'rp-status';
                                status.textContent = '';
                            }
                        }
                        // Clear URL params after handling
                        if (window.history.replaceState) {
                            window.history.replaceState({}, document.title, window.location.pathname);
                        }
                    };

                    window.submitNewPassword = async function () {
                        const newPassword = document.getElementById('rpNewPassword').value;
                        const confirmPassword = document.getElementById('rpConfirmPassword').value;
                        const submitBtn = document.getElementById('rpSubmitBtn');
                        const status = document.getElementById('rpStatus');

                        // Validation
                        if (!newPassword || !confirmPassword) {
                            status.className = 'rp-status error';
                            status.textContent = 'Please fill in both fields.';
                            return;
                        }

                        if (newPassword.length < 6) {
                            status.className = 'rp-status error';
                            status.textContent = 'Password must be at least 6 characters.';
                            return;
                        }

                        if (newPassword !== confirmPassword) {
                            status.className = 'rp-status error';
                            status.textContent = 'Passwords do not match.';
                            return;
                        }

                        // Disable button
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Updating...';

                        try {
                            const { data, error } = await AuthManager.updatePassword(newPassword);
                            if (error) {
                                status.className = 'rp-status error';
                                status.textContent = error.message || 'Failed to update password.';
                            } else {
                                status.className = 'rp-status success';
                                status.innerHTML = '<i class="fa-solid fa-check-circle"></i> Password updated successfully!';
                                localStorage.removeItem('pending_password_reset');

                                // Auto close and show toast after 2 seconds
                                setTimeout(() => {
                                    window.closeResetPasswordModal();
                                    if (window.showToast) {
                                        window.showToast('Password updated! You can now sign in.', 'success');
                                    }
                                    // Reload to clear any stale session state
                                    setTimeout(() => location.reload(), 1000);
                                }, 2000);
                            }
                        } catch (e) {
                            status.className = 'rp-status error';
                            status.textContent = e.message || 'Something went wrong.';
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fa-solid fa-check"></i> Update Password';
                        }
                    };

                    // Check for password reset URL on page load
                    window.addEventListener('DOMContentLoaded', function () {
                        const checkAndShowModal = () => {
                            if (window.showResetPasswordModal) {
                                window.showResetPasswordModal();
                                console.log("✅ Reset Password Modal Triggered");
                            } else {
                                console.warn("⚠️ showResetPasswordModal not found, retrying...");
                                setTimeout(checkAndShowModal, 500);
                            }
                        };

                        // 1. URL Detection
                        const urlParams = new URLSearchParams(window.location.search);
                        const hashParams = new URLSearchParams(window.location.hash.substring(1));
                        const isReset = urlParams.get('reset') === 'true';
                        const isRecovery = hashParams.get('type') === 'recovery';

                        if (isReset || isRecovery) {
                            console.log('🔑 Password reset detected via URL');
                            setTimeout(checkAndShowModal, 1000);
                        }

                        // 2. Supabase Event Detection (Robust)
                        if (window.supabaseClient) {
                            window.supabaseClient.auth.onAuthStateChange(async (event, session) => {
                                if (event === 'PASSWORD_RECOVERY') {
                                    console.log('🔑 PASSWORD_RECOVERY event received');
                                    setTimeout(checkAndShowModal, 500);
                                }
                            });
                        }
                    });

                    // Close on backdrop click
                    setTimeout(() => {
                        const modal = document.getElementById('resetPasswordModal');
                        if (modal) {
                            modal.addEventListener('click', function (e) {
                                if (e.target === this) {
                                    window.closeResetPasswordModal();
                                }
                            });
                        }
                    }, 500);




                    // Modal Control Functions (Restored)
                    window.showResetPasswordModal = function () {
                        const modal = document.getElementById('resetPasswordModal');
                        if (modal) {
                            modal.classList.add('rp-visible');
                            modal.style.display = 'flex';
                            modal.style.zIndex = '99999999';
                            // Clear fields
                            const p1 = document.getElementById('rpNewPassword');
                            const p2 = document.getElementById('rpConfirmPassword');
                            if (p1) p1.value = '';
                            if (p2) p2.value = '';
                        }
                    };

                    window.closeResetPasswordModal = function () {
                        const modal = document.getElementById('resetPasswordModal');
                        if (modal) {
                            modal.classList.remove('rp-visible');
                            setTimeout(() => { modal.style.display = 'none'; }, 300);
                        }
                    };

                    // Global Reset Password Enforcement
                    window.enforceResetPasswordModal = function () {
                        const isPending = localStorage.getItem('pending_password_reset') === 'true';
                        if (!isPending) return;

                        if (window.resetModalEnforcer) clearInterval(window.resetModalEnforcer);
                        console.log('🔒 Starting strict enforcement of Reset Password Modal');

                        window.resetModalEnforcer = setInterval(() => {
                            if (localStorage.getItem('pending_password_reset') !== 'true') {
                                clearInterval(window.resetModalEnforcer);
                                return;
                            }

                            const modal = document.getElementById('resetPasswordModal');
                            if (window.showResetPasswordModal) {
                                if (!modal || !modal.classList.contains('rp-visible') || modal.style.display === 'none') {
                                    console.log('🔒 Enforcing Reset Password Modal Visibility');
                                    window.showResetPasswordModal();
                                    if (modal) {
                                        modal.style.display = 'flex';
                                        modal.style.opacity = '1'; // Force Opaque
                                        modal.style.visibility = 'visible'; // Force Visible
                                        modal.style.setProperty('z-index', '2147483647', 'important');

                                        // Debug Indicator
                                        document.title = "⚠️ SET PASSWORD REQUIRED ⚠️";

                                        // Also Force Hide Login Screen
                                        const loginScreen = document.getElementById('loginScreen');
                                        if (loginScreen) loginScreen.style.display = 'none';
                                    }
                                }
                            }
                            // Hide Cancel/Close Buttons
                            const cancelBtns = document.querySelectorAll('#resetPasswordModal .fp-btn-cancel, #resetPasswordModal .close-btn');
                            cancelBtns.forEach(btn => btn.style.display = 'none');
                        }, 100);
                    };

                    // Check for pending password reset from localStorage (Robust Fallback)
                    window.addEventListener('DOMContentLoaded', () => {
                        window.enforceResetPasswordModal();
                    });
                </script>

                <!-- ==================== NOTIFICATION PERMISSION MODAL ==================== -->
                <div id="notificationPermissionModal"
                    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:999999; justify-content:center; align-items:center;">
                    <div
                        style="background:var(--card-bg, #fff); border-radius:20px; padding:30px; max-width:400px; width:90%; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                        <div style="font-size:60px; margin-bottom:15px;">🔔</div>
                        <h2 style="margin:0 0 10px; color:var(--dark-text, #2c3e50);">Notification Settings</h2>
                        <p style="color:var(--medium-text, #6c757d); margin-bottom:25px; font-size:14px;">
                            Configure your daily attendance reminders.
                        </p>

                        <!-- Notification Toggle -->
                        <!-- Notification Toggle -->
                        <div style="margin-bottom: 20px; text-align: left; background: var(--light-bg); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;"
                            onmouseover="this.style.background='var(--hover-bg, #eef2f7)'"
                            onmouseout="this.style.background='var(--light-bg)'">
                            <label for="notificationToggle" style="font-weight: 600; flex: 1; cursor: pointer;">Enable
                                Notifications</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notificationToggle" onchange="toggleNotificationState()"
                                    style="opacity: 0.1; width: 50px; height: 28px; z-index: 10; position: absolute; cursor: pointer;">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <!-- Time Picker (Hidden if disabled) -->
                        <div id="timePickerContainer" style="margin-bottom: 25px; text-align: left;">
                            <label
                                style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem;">Daily
                                Reminder Time</label>
                            <input type="time" id="reminderTimeInput" value="18:00"
                                style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1.1rem; background: var(--card-bg); color: var(--dark-text);">
                            <p style="font-size: 0.8rem; color: var(--medium-text); margin-top: 5px;">We'll send a
                                reminder at this time everyday.</p>
                        </div>

                        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                            <button onclick="saveDailyReminderSettings()"
                                style="padding:12px 24px; border:none; border-radius:10px; background:linear-gradient(135deg, #667eea, #764ba2); color:white; font-size:16px; font-weight:600; cursor:pointer; flex:1;">
                                💾 Save Settings
                            </button>
                            <button onclick="closeNotificationModal()"
                                style="padding:12px 24px; border:none; border-radius:10px; background:var(--light-bg, #f0f2f5); color:var(--dark-text, #2c3e50); font-size:16px; cursor:pointer; flex:0.5;">
                                Close
                            </button>
                        </div>
                        <div style="margin-top: 15px;">
                            <button onclick="window.sendTestNotification()"
                                style="background:none; border:none; color:var(--primary-color); font-size:0.9rem; text-decoration:underline; cursor:pointer; opacity:0.8;">
                                🧪 Send Test Notification Now
                            </button>
                        </div>
                    </div>
                </div>

                <script>
                    // Test Notification Logic
                    window.sendTestNotification = async function () {
                        const toggle = document.getElementById('notificationToggle');
                        if (!toggle.checked && Notification.permission !== 'granted') {
                            alert('⚠️ Please enable notifications via the toggle first.');
                            return;
                        }

                        if (typeof showToast === 'function') showToast('🚀 Sending test notification...', 'info');

                        // 1. Try Local Immediate Notification (Fastest check)
                        try {
                            if (Notification.permission === 'granted') {
                                if ('serviceWorker' in navigator) {
                                    const reg = await navigator.serviceWorker.ready;
                                    reg.showNotification('✅ Test Notification', {
                                        body: 'Your device is ready to receive reminders!',
                                        icon: '/icon-192x192.png',
                                        badge: '/icon-192x192.png',
                                        vibrate: [200, 100, 200]
                                    });
                                } else {
                                    new Notification('✅ Test Notification', {
                                        body: 'Your device is ready to receive reminders!',
                                        icon: '/icon-192x192.png'
                                    });
                                }
                            } else {
                                // Force request if not granted but UI says enabled (edge case)
                                const perm = await Notification.requestPermission();
                                if (perm === 'granted') window.sendTestNotification(); // Retry
                            }
                        } catch (e) {
                            console.error('Local notification failed:', e);
                            alert('Error showing notification: ' + e.message);
                        }
                    };

                    function closeNotificationModal() {
                        const modal = document.getElementById('notificationPermissionModal');
                        if (modal) modal.style.display = 'none';
                    }
                </script>

                <script>
                    // ==================== NOTIFICATION PERMISSION FUNCTIONS ====================

                    // Show notification permission modal
                    // Show notification permission modal
                    window.showNotificationPermissionModal = async function () {
                        const modal = document.getElementById('notificationPermissionModal');
                        if (modal) {
                            // Pre-fill values based on saved preference (default to browser perm if no preference)
                            const savedState = localStorage.getItem('notificationsEnabled');
                            let isEnabled;

                            if (savedState !== null) {
                                isEnabled = savedState === 'true';
                            } else {
                                isEnabled = Notification.permission === 'granted';
                            }

                            document.getElementById('notificationToggle').checked = isEnabled;
                            toggleNotificationState(true); // Silent update

                            // Load saved time from localStorage or default
                            const savedTime = localStorage.getItem('reminderTime') || "18:00";
                            document.getElementById('reminderTimeInput').value = savedTime;

                            modal.style.display = 'flex';
                            console.log('🔔 Showing notification settings modal. Enabled:', isEnabled);
                        }
                    };

                    window.toggleNotificationState = function (silent = false) {
                        const isChecked = document.getElementById('notificationToggle').checked;
                        const timePicker = document.getElementById('timePickerContainer');
                        if (isChecked) {
                            timePicker.style.display = 'block';
                            timePicker.style.opacity = '1';
                            if (!silent && typeof window.showToast === 'function') window.showToast('Notifications ON - Set your time below', 'success');
                        } else {
                            timePicker.style.display = 'none';
                            if (!silent && typeof window.showToast === 'function') window.showToast('Notifications turned OFF', 'info');
                        }

                        // Auto-save toggle state to localStorage for UI persistence (final save to DB happens on Save button)
                        localStorage.setItem('notificationsEnabled', isChecked);
                    };

                    window.closeNotificationModal = function () {
                        const modal = document.getElementById('notificationPermissionModal');
                        if (modal) modal.style.display = 'none';
                    }

                    // Toast Function
                    window.showToast = function (message, type = 'info') {
                        const container = document.getElementById('toast-container');
                        if (!container) return;

                        const toast = document.createElement('div');
                        toast.className = `toast ${type}`;

                        let icon = 'ℹ️';
                        if (type === 'success') icon = '✅';
                        if (type === 'error') icon = '❌';

                        toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
                        container.appendChild(toast);

                        // Animate in
                        requestAnimationFrame(() => toast.classList.add('show'));

                        // Remove after 3s
                        setTimeout(() => {
                            toast.classList.remove('show');
                            setTimeout(() => toast.remove(), 300);
                        }, 3000);
                    };

                    window.saveDailyReminderSettings = async function () {
                        try {
                            const params = {
                                isEnabled: document.getElementById('notificationToggle').checked,
                                time: document.getElementById('reminderTimeInput').value
                            };
                            console.log('💾 Saving Notification Settings:', params);

                            const modal = document.getElementById('notificationPermissionModal');

                            if (!params.time) {
                                alert("Please select a valid time.");
                                return;
                            }

                            if (params.isEnabled) {
                                // Request permission if not already granted
                                if (Notification.permission !== 'granted') {
                                    console.log('🔔 Requesting permission...');
                                    const permission = await Notification.requestPermission();
                                    if (permission !== 'granted') {
                                        alert("Permission denied. Please allow notifications in browser settings.");
                                        return;
                                    }
                                }

                                // Get/Refresh Token
                                const token = await window.requestNotificationPermission();
                                if (token) {
                                    // Save settings to Firestore
                                    await updateFirestoreSettings(token, true, params.time);
                                    localStorage.setItem('reminderTime', params.time);
                                    window.showToast(`Reminder set for ${params.time} daily!`, 'success');
                                } else {
                                    throw new Error("Failed to get notification token. Check internet connection.");
                                }
                            } else {
                                // User disabled notifications
                                const token = localStorage.getItem('fcmToken');
                                console.log('🔕 Disabling notifications. Token:', token);

                                if (token) {
                                    await updateFirestoreSettings(token, false, params.time);
                                    window.showToast('Notifications disabled.', 'info');
                                } else {
                                    // No token found (never enabled or cleared)
                                    window.showToast('Notifications are OFF.', 'info');
                                }
                            }

                            localStorage.setItem('notificationPromptShown', 'true');
                            if (modal) modal.style.display = 'none';
                        } catch (error) {
                            console.error("Save Settings Error:", error);
                            alert("Error saving settings: " + (error.message || error));
                        }
                    };

                    async function updateFirestoreSettings(token, enabled, time) {
                        if (!window.firestoreDb || !token) return;

                        try {
                            const { doc, setDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js");
                            const userRef = doc(window.firestoreDb, "notification_tokens", token);

                            // Extract hour for efficient querying
                            const reminderHour = parseInt(time.split(':')[0], 10);

                            await setDoc(userRef, {
                                reminderTime: time,
                                reminderHour: reminderHour, // Store hour separately (0-23)
                                enabled: enabled,
                                updatedAt: serverTimestamp()
                            }, { merge: true });
                            console.log("✅ Firestore settings updated:", { enabled, time, reminderHour });
                        } catch (e) {
                            console.error("❌ Error updating Firestore settings:", e);
                        }
                    }

                    // Auto-trigger logic remains (simplified)
                    window.addEventListener('load', () => {
                        const hasData = localStorage.getItem('classesData') || localStorage.getItem('userName');
                        const isFirstVisit = !localStorage.getItem('notificationPromptShown');
                        if (hasData && isFirstVisit) {
                            setTimeout(() => window.showNotificationPermissionModal(), 3000);
                        }
                    });
                </script>
                <!-- Toast Container -->
                <div id="toast-container"></div>

                <!-- Notification Settings FAB -->
                <button onclick="window.showNotificationPermissionModal()" class="fab-glass"
                    style="bottom: 20px; right: 20px; font-size: 24px;">
                    🔔
                </button>
                <!-- Community Modal -->
                <div id="communityModal" class="modal">
                    <div class="modal-content full-screen-modal">
                        <button class="modal-close" onclick="closeModal('communityModal')">&times;</button>
                        <div class="modal-header">
                            <h2>🗳️ Class Community</h2>
                            <p>Polls & Mass Bunks for <span id="communityClassName">...</span></p>
                        </div>

                        <div id="communityLoading" class="loading-spinner"
                            style="display:none; text-align:center; padding:20px;">
                            <div class="spinner"></div>
                            <p>Checking class eligibility...</p>
                        </div>

                        <div id="communityContent" style="display:none;">
                            <!-- Status Dashboard -->
                            <div class="status-card"
                                style="background: var(--light-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                                <h3>👥 Class Readiness</h3>
                                <p class="status-subtitle"
                                    style="font-size: 0.9rem; color: var(--medium-text); margin-bottom: 15px;">
                                    Mass Bunk unlocks when <strong>ALL</strong> active members have marked today's
                                    attendance AND are safe (>75%).
                                </p>

                                <div id="communityStatusList" class="status-list"
                                    style="display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto;">
                                    <!-- Rendered by JS -->
                                </div>

                                <div id="communityAlert" class="alert-box"
                                    style="margin-top: 15px; padding: 10px; border-radius: 8px; font-size: 0.9rem;">
                                    Checking...
                                </div>
                            </div>

                            <!-- Active Polls Section -->
                            <div id="pollsSection"
                                style="margin-top: 20px; display:none; opacity: 0.5; pointer-events: none;">
                                <div
                                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                    <h3>Active Polls</h3>
                                    <button id="createPollBtn" class="btn primary-btn"
                                        onclick="CommunityManager.openCreatePollModal()" disabled>+ Create Mass Bunk
                                        Poll</button>
                                </div>
                                <div id="pollsFeed" class="polls-feed">
                                    <!-- Rendered by JS -->
                                    <div class="empty-state"
                                        style="text-align:center; color: var(--medium-text); padding: 20px;">
                                        No active polls yet.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <style>
                    /* Community Styles */
                    .member-item {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 8px 12px;
                        background: white;
                        border-radius: 8px;
                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                    }

                    .member-info {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }

                    .member-status-icon {
                        font-size: 1.2rem;
                    }

                    .member-name {
                        font-weight: 500;
                        color: var(--main-text);
                    }

                    .member-percent {
                        font-size: 0.85rem;
                        color: var(--medium-text);
                    }

                    .status-ready {
                        border-left: 4px solid #2ecc71;
                    }

                    .status-not-ready {
                        border-left: 4px solid #e74c3c;
                    }

                    .status-pending {
                        border-left: 4px solid #f1c40f;
                    }

                    .alert-box.success {
                        background: #d4edda;
                        color: #155724;
                        border: 1px solid #c3e6cb;
                    }

                    .alert-box.warning {
                        background: #fff3cd;
                        color: #856404;
                        border: 1px solid #ffeeba;
                    }

                    .alert-box.danger {
                        background: #f8d7da;
                        color: #721c24;
                        border: 1px solid #f5c6cb;
                    }

                    .polls-unlocked {
                        opacity: 1 !important;
                        pointer-events: auto !important;
                    }
                </style>

                <script>
                    // Render Function used by CommunityManager
                    window.renderCommunityModal = function () {
                        const modal = document.getElementById('communityModal');
                        const loading = document.getElementById('communityLoading');
                        const content = document.getElementById('communityContent');
                        const list = document.getElementById('communityStatusList');
                        const alertBox = document.getElementById('communityAlert');
                        const pollsSection = document.getElementById('pollsSection');
                        const createBtn = document.getElementById('createPollBtn');
                        const classNameDisplay = document.getElementById('communityClassName');

                        // Show Modal
                        modal.style.display = 'block';
                        classNameDisplay.textContent = CommunityManager.currentClassId || 'Unknown Class';

                        // Check State
                        if (!CommunityManager.members || CommunityManager.members.length === 0) {
                            loading.style.display = 'block';
                            content.style.display = 'none';
                            return;
                        }

                        // Hide Loading, Show Content
                        loading.style.display = 'none';
                        content.style.display = 'block';

                        // Render Members Status
                        list.innerHTML = '';
                        let allReady = true;
                        let missingLogs = false;
                        let lowAttendance = false;

                        CommunityManager.members.forEach(m => {
                            const div = document.createElement('div');
                            div.className = 'member-item ' + (m.ready ? 'status-ready' : 'status-not-ready');

                            let icon = '✅';
                            let statusText = 'Ready';

                            if (!m.ready) {
                                allReady = false;
                                icon = '❌';
                                statusText = 'Low Attendance (<75%)';
                                lowAttendance = true;
                            }

                            // Note: IsLogUpdated check is implicit in can_mass_bunk for now based on strict rule

                            div.innerHTML = `
                    <div class="member-info">
                        <span class="member-status-icon">${icon}</span>
                        <div>
                            <div class="member-name">${m.name}</div>
                            <div class="member-percent">${m.percentage}% Attendance</div>
                        </div>
                    </div>
                `;
                            list.appendChild(div);
                        });

                        // Update Alert & Poll Section
                        pollsSection.className = ''; // Reset

                        if (allReady) {
                            alertBox.className = 'alert-box success';
                            alertBox.innerHTML = '🎉 <strong>Mass Bunk Unlocked!</strong> All members are eligible.';

                            pollsSection.style.display = 'block';
                            pollsSection.classList.add('polls-unlocked');
                            createBtn.disabled = false;

                            // Load Polls (Chunk 3)
                            if (CommunityManager.loadPolls) CommunityManager.loadPolls();

                        } else {
                            alertBox.className = 'alert-box danger';
                            alertBox.innerHTML = '⛔ <strong>Mass Bunk Locked.</strong> Some members are not eligible (Low Attendance).';

                            pollsSection.style.display = 'block';
                            pollsSection.classList.remove('polls-unlocked'); // Greys it out
                            createBtn.disabled = true;
                        }
                    };
                </script>
                <!-- Create Poll Modal -->
                <div id="createPollModal" class="modal">
                    <div class="modal-content">
                        <button class="modal-close" onclick="closeModal('createPollModal')">&times;</button>
                        <div class="modal-header">
                            <h2>📢 Create Mass Bunk Poll</h2>
                        </div>
                        <div class="input-group">
                            <label>Subject</label>
                            <select id="pollSubject" class="full-width-input">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Target Date</label>
                            <input type="date" id="pollDate" class="full-width-input">
                        </div>
                        <div class="input-group">
                            <label>Message (Optional)</label>
                            <textarea id="pollMessage" class="full-width-input"
                                placeholder="Why are we bunking? (e.g. Professor absent)"></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn primary-btn" onclick="submitCreatePoll()">Create Poll</button>
                            <button class="btn secondary-btn" onclick="closeModal('createPollModal')">Cancel</button>
                        </div>
                    </div>
                </div>

                <script>
                    // UI Helpers for Polls
                    window.openCreatePollModal = function () {
                        const modal = document.getElementById('createPollModal');
                        const subjectSelect = document.getElementById('pollSubject');
                        const dateInput = document.getElementById('pollDate');

                        // Populate Subjects
                        subjectSelect.innerHTML = '';
                        if (window.selectedClass && window.selectedClass.subjects) {
                            window.selectedClass.subjects.forEach(s => {
                                const opt = document.createElement('option');
                                opt.value = s.name;
                                opt.textContent = s.name;
                                subjectSelect.appendChild(opt);
                            });
                        }

                        // Default Date = Tomorrow
                        const tomorrow = new Date();
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        dateInput.value = tomorrow.toISOString().split('T')[0];

                        modal.style.display = 'block';
                    };

                    window.submitCreatePoll = function () {
                        const subject = document.getElementById('pollSubject').value;
                        const date = document.getElementById('pollDate').value;
                        const msg = document.getElementById('pollMessage').value;

                        if (!subject || !date) {
                            alert("Please select a subject and date.");
                            return;
                        }

                        CommunityManager.createPoll(subject, date, msg);
                    };

                    window.renderPolls = function (polls) {
                        const feed = document.getElementById('pollsFeed');
                        if (!feed) return;

                        feed.innerHTML = '';

                        if (polls.length === 0) {
                            feed.innerHTML = '<div class="empty-state" style="text-align:center; padding:20px; color:var(--medium-text);">No active mass bunk polls.</div>';
                            return;
                        }

                        polls.forEach(p => {
                            const card = document.createElement('div');
                            card.className = 'poll-card ' + (p.isExpired ? 'expired' : '');
                            card.style.cssText = `
                    background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
                    border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                `;
                            if (p.isExpired) card.style.opacity = '0.6';

                            // Vote Buttons
                            // Only show buttons if active. If voted, highlight selection.
                            const yesClass = p.myVote === 'yes' ? 'selected' : '';
                            const noClass = p.myVote === 'no' ? 'selected' : '';

                            let actionButtons = '';
                            if (!p.isExpired) {
                                actionButtons = `
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="poll-btn yes-btn ${yesClass}" onclick="CommunityManager.vote('${p.id}', 'yes')">
                                👍 Yes (${p.yesCount})
                            </button>
                            <button class="poll-btn no-btn ${noClass}" onclick="CommunityManager.vote('${p.id}', 'no')">
                                👎 No (${p.noCount})
                            </button>
                        </div>
                    `;
                            } else {
                                actionButtons = `
                        <div style="margin-top:10px; font-weight:bold; color:var(--medium-text);">
                            Result: Yes (${p.yesCount}) - No (${p.noCount}) [Expired]
                        </div>
                    `;
                            }

                            card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <div style="font-weight:600; font-size:1.1rem;">${p.subject_name}</div>
                            <div style="font-size:0.85rem; color:var(--medium-text);">📅 ${p.date} • by ${p.initiatorName}</div>
                        </div>
                        ${p.isExpired ? '<span class="status-badge" style="background:#eee; color:#666; padding:2px 8px; border-radius:4px; font-size:0.75rem;">Expired</span>' : '<span class="status-badge" style="background:#e3f2fd; color:#1e88e5; padding:2px 8px; border-radius:4px; font-size:0.75rem;">Active</span>'}
                    </div>
                    ${p.message ? `<div style="margin:10px 0; font-style:italic; color:#555;">"${p.message}"</div>` : ''}
                    ${actionButtons}
                    <div style="margin-top:8px; font-size:0.8rem; color:#888;">
                        ${p.yesCount + p.noCount} votes total
                    </div>
                `;
                            feed.appendChild(card);
                        });
                    };
                </script>
                <style>
                    .poll-btn {
                        flex: 1;
                        padding: 8px;
                        border-radius: 6px;
                        border: 1px solid #ddd;
                        background: #fafafa;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }

                    .poll-btn:hover {
                        background: #f0f0f0;
                    }

                    .poll-btn.yes-btn.selected {
                        background: #d4edda;
                        border-color: #c3e6cb;
                        font-weight: bold;
                        color: #155724;
                    }

                    .poll-btn.no-btn.selected {
                        background: #f8d7da;
                        border-color: #f5c6cb;
                        font-weight: bold;
                        color: #721c24;
                    }
                </style>
</body>

</html>